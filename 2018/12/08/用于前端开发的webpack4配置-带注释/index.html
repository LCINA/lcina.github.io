<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="前端,">










<meta name="description" content="原文链接  随着web开发变得越来越复杂，我们需要使用工具来帮助我们构建现代化网站。这是一个完整通过复杂webpack4配置的线上生产例子。  构建现代化网站已经成为自定义应用程序开发，网站期望能做的更多，具有传统应用的功能，而不仅仅是一个推广网站。 随着一个流程变得复杂时，我们就会将它分解为可管理的组件，并使用工具进行自动化构建，比如制造汽车、起草法案[法律文件]、建立网站。">
<meta name="keywords" content="前端">
<meta property="og:type" content="article">
<meta property="og:title" content="用于前端开发的webpack4配置[带注释]">
<meta property="og:url" content="http://lcina.github.io/2018/12/08/用于前端开发的webpack4配置-带注释/index.html">
<meta property="og:site_name" content="Lcina的博客">
<meta property="og:description" content="原文链接  随着web开发变得越来越复杂，我们需要使用工具来帮助我们构建现代化网站。这是一个完整通过复杂webpack4配置的线上生产例子。  构建现代化网站已经成为自定义应用程序开发，网站期望能做的更多，具有传统应用的功能，而不仅仅是一个推广网站。 随着一个流程变得复杂时，我们就会将它分解为可管理的组件，并使用工具进行自动化构建，比如制造汽车、起草法案[法律文件]、建立网站。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/8/166f3f8201be4e9a?w=1200&h=675&f=png&s=138466">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/8/166f405cd611587f?w=1200&h=675&f=png&s=656595">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/10/166fc29b871796ef?w=1200&h=675&f=png&s=211750">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/10/166fd86a65ffe9ba?w=1200&h=675&f=png&s=714693">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/20/1673059d3cf516a9?w=992&h=1315&f=png&s=287267">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/12/5/16779f3aca8f50ac?w=1200&h=699&f=png&s=262901">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/12/5/1677f14f05c3db38?w=1200&h=675&f=png&s=865987">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/12/8/1678d54c7280b364?w=1200&h=675&f=png&s=117830">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/12/8/1678d6807ef71a48?w=1200&h=675&f=png&s=709862">
<meta property="og:updated_time" content="2018-12-08T11:03:08.462Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用于前端开发的webpack4配置[带注释]">
<meta name="twitter:description" content="原文链接  随着web开发变得越来越复杂，我们需要使用工具来帮助我们构建现代化网站。这是一个完整通过复杂webpack4配置的线上生产例子。  构建现代化网站已经成为自定义应用程序开发，网站期望能做的更多，具有传统应用的功能，而不仅仅是一个推广网站。 随着一个流程变得复杂时，我们就会将它分解为可管理的组件，并使用工具进行自动化构建，比如制造汽车、起草法案[法律文件]、建立网站。">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/11/8/166f3f8201be4e9a?w=1200&h=675&f=png&s=138466">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
  (function(){
    if(''){
      if (prompt('请输入文章密码') !== ''){
          alert('密码错误！');
          history.back();
      }
    }
  })();
</script>



  <link rel="canonical" href="http://lcina.github.io/2018/12/08/用于前端开发的webpack4配置-带注释/">





  <title>用于前端开发的webpack4配置[带注释] | Lcina的博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?afe5ccc67e80010f408dc44bbb72d0b7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lcina的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lcina.github.io/2018/12/08/用于前端开发的webpack4配置-带注释/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lcina">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lcina的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">用于前端开发的webpack4配置[带注释]</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-08T19:01:39+08:00">
                2018-12-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/12/08/用于前端开发的webpack4配置-带注释/" class="leancloud_visitors" data-flag-title="用于前端开发的webpack4配置[带注释]">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p><a href="https://nystudio107.com/blog/an-annotated-webpack-4-config-for-frontend-web-development" target="_blank" rel="noopener">原文链接</a></p>
</blockquote>
<p>随着web开发变得越来越复杂，我们需要使用工具来帮助我们构建现代化网站。这是一个完整通过复杂webpack4配置的线上生产例子。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/11/8/166f3f8201be4e9a?w=1200&amp;h=675&amp;f=png&amp;s=138466" alt=""></p>
<p>构建现代化网站已经成为自定义应用程序开发，网站期望能做的更多，具有传统应用的功能，而不仅仅是一个推广网站。</p>
<p>随着一个流程变得复杂时，我们就会将它分解为可管理的组件，并使用工具进行自动化构建，比如制造汽车、起草法案[法律文件]、建立网站。<br><a id="more"></a></p>
<blockquote>
<p>使用正确的工具完成工作</p>
</blockquote>
<p>像webpack这样的工具一直处于现代web开发的最前沿，正是因为如此，它帮助我们构建复杂的事物。</p>
<p>webpack4拥有一些意想不到的改进，最吸引我的就是它在构建速度上面变得有多快，所以我决定采用它。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/11/8/166f405cd611587f?w=1200&amp;h=675&amp;f=png&amp;s=656595" alt=""></p>
<p>hold住，因为这是一篇充满大量信息的长篇文章。</p>
<h2 id="采用webpack"><a href="#采用webpack" class="headerlink" title="采用webpack"></a>采用webpack</h2><p>一年多以前，我发表了一篇文章： <a href="https://nystudio107.com/blog/a-gulp-workflow-for-frontend-development-automation" target="_blank" rel="noopener">A Gulp Workflow for Frontend Development Automation</a>[用于前端自动化的gulp工作流]，讲解了如何使用<code>gulp</code>完成同样的事情。然而在这段时间里，我越来越多地使用像<a href="http://vuejs.org/" target="_blank" rel="noopener">Vue-JS</a>和<a href="http://graphql.org/" target="_blank" rel="noopener">GraphQL</a>这样的前端框架，如<a href="https://nystudio107.com/blog/using-vuejs-graphql-to-make-practical-magic" target="_blank" rel="noopener">Using VueJS + GraphQL to make Practical Magic</a>这篇文章。</p>
<p>我发现webpack让我更容易的去构建各种类型的网站以及应用程序，而且它也允许我使用最现代化的工具链。</p>
<p>还有其他选择：</p>
<ul>
<li><p><a href="https://laravel.com/docs/5.7/mix#introduction" target="_blank" rel="noopener">Laravel Mix</a>是基于webpack的构建工具层，它十分简洁，你可以快速启动并运行，它可以在90%的时间内完成你想要的任务，但剩下的10%无论如何都会进入到webpack，目前还不支持webpack4。</p>
</li>
<li><p>如果你只是用VueJS前端框架，那么使用<a href="http://cli.vuejs.org/" target="_blank" rel="noopener">vue-cli</a>是个不错的选择，它也是基于webpack，大部分时间都可以工作，并且为你做一些意想不到的事情。但同样的，当它提供的功能已经满足不了你的需求，你还是需要用到webpack，而且我并不是只使用VueJS。</p>
</li>
<li><p>Neutrino也是基于webpack，我们可以关注博客：<a href="https://devmode.fm/episodes/neutrino-how-i-learned-to-stop-worrying-and-love-webpack" target="_blank" rel="noopener">Neutrino: How I Learned to Stop Worrying and Love Webpack</a>。神奇的点就是它可以通过像搭乐高积木一样去配置webpack，但学习使用让的成本跟学习webpack其实差不了多少。</p>
</li>
</ul>
<p>如果你选择上述工具（或者其他工具），我不会对你提出任：它们都是基于webpack封装。</p>
<blockquote>
<p>理解开发系统中层是如何工作的是有好处的。</p>
</blockquote>
<p>最终，你只需要决定你希望站在前端技术金字塔中的哪个位置。</p>
<p>某些时候，我认为了解像webpack这样重要的工具是如何工作是有意义的。不久前，我向<a href="http://twitter.com/nystudio107/status/941488105600765952" target="_blank" rel="noopener">Sean Larkin</a>（webpack核心团队成员之一）抱怨说webpack就像一个“黑匣子”，他的回答简洁却非常精辟：</p>
<blockquote>
<p>It’s only black if you haven’t opened it.[如果你没有打开这个所谓的“黑匣子”，它永远都是未知的。]</p>
</blockquote>
<p>他说的对，是时候打开“黑匣子”了。</p>
<p>本文不会教你所有关于webpack的知识，甚至是如何安装它，下面有很多、资料给你选择，你可以选择你认为不错的方式：</p>
<ul>
<li><p><a href="https://medium.com/@rajaraodv/webpack-the-confusing-parts-58712f8fcad9" target="_blank" rel="noopener">webpack—the Confusing Parts</a> ——简要概述了webpack的工作原理。</p>
</li>
<li><p><a href="https://webpack.js.org/concepts/" target="_blank" rel="noopener">webpack documentation</a> —— 建议读webpack官方文档，如果你想学好它的话</p>
</li>
<li><p><a href="https://frontendmasters.com/courses/webpack-fundamentals/" target="_blank" rel="noopener">webpack fundamentals</a> —— webpack教学视频</p>
</li>
<li><p><a href="http://www.valentinog.com/blog/from-gulp-to-webpack-4-tutorial/" target="_blank" rel="noopener">How to switch from Gulp to webpack</a></p>
</li>
</ul>
<p>这样的资料还有很多，相反地本文将用webpack4配置一个复杂的完整工作例子，并添加注释。你可以使用完整的示例，也可以使用它的部分配置项，但希望你可以从中学到一些东西。在我学习webpack的过程中，我发现有很多教程视频，一堆文章给你将如何安装它并添加一些基础配置，但却大部分没有实际线上生产环境的webpack配置示例，所以我写了这篇文章。</p>
<h2 id="WHAT-WE-GET-OUT-OF-THE-BOX"><a href="#WHAT-WE-GET-OUT-OF-THE-BOX" class="headerlink" title="WHAT WE GET OUT OF THE BOX"></a>WHAT WE GET OUT OF THE BOX</h2><p>当我开始通过打开“黑匣子”来学习webpack时，我有一份我依赖的技术列表，我想将它成为构建流程的一部分。我也会花时间四处看看，看看在这个过程中，我还能采用什么。</p>
<p>正如在文章 <a href="https://nystudio107.com/blog/a-pretty-website-isnt-enough" target="_blank" rel="noopener">A Pretty Website Isn’t Enough article</a>讨论的那样，网站性能一直都是我关注的重点，所以在配置webpack过程中关注性能问题也很正常。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/11/10/166fc29b871796ef?w=1200&amp;h=675&amp;f=png&amp;s=211750" alt=""></p>
<p>所以这是我想用webpack为我处理的事情，以及我希望在构建过程中加入的技术：</p>
<ul>
<li><p><a href="https://webpack.js.org/guides/production/" target="_blank" rel="noopener">Development / Production</a> —— 在本地开发中，我通过<a href="https://webpack.js.org/guides/production/" target="_blank" rel="noopener">webpack-dev-server</a>进行快速构建，对于生产环境的构建（通常通过<a href="http://buddy.works" target="_blank" rel="noopener">buddy.works</a>在Docker容器中构建），我希望尽可能优化每一个点。因此，我们区分<code>dev</code>和<code>prod</code>的配置以及构建。</p>
</li>
<li><p><a href="https://webpack.js.org/concepts/hot-module-replacement/" target="_blank" rel="noopener">Hot Module Replacement</a> —— 当我修改了js、css或者页面，我希望网页能够自动刷新，大幅度提高了开发效率：不需要你去点浏览器刷新按钮。</p>
</li>
<li><p><a href="https://webpack.js.org/guides/code-splitting/#dynamic-imports" target="_blank" rel="noopener">Dynamic Code Splitting</a> —— 我不想手动在配置文件中定义js chunk，所以我让webpack帮我解决这个问题。</p>
</li>
<li><p><a href="https://webpack.js.org/guides/lazy-loading/" target="_blank" rel="noopener">Lazy Loading</a> —— 又称异步动态模块加载，在需要时加载所需的代码资源。</p>
</li>
<li><p><a href="http://philipwalton.com/articles/deploying-es2015-code-in-production-today/" target="_blank" rel="noopener">Modern &amp; Legacy JS Bundles</a> —— 我想将es2015 + JavaScript模块发布到能够支持全球75%以上的浏览器上，同时为低版本的浏览器提供一个补丁包（包括所有转码和polyfills）。</p>
</li>
<li><p><a href="https://webpack.js.org/guides/caching/" target="_blank" rel="noopener">Cache Busting via manifest.json</a> —— 可以让我们为静态资源设置缓存，同时保证它们在更改使自动重新缓存。</p>
</li>
<li><p><a href="http://developers.google.com/speed/docs/insights/OptimizeCSSDelivery" target="_blank" rel="noopener">Critical CSS</a> —— 根据文章<a href="https://nystudio107.com/blog/implementing-critical-css" target="_blank" rel="noopener">Implementing Critical CSS on your website</a>，可以提高首页面的加载速度。</p>
</li>
<li><p><a href="http://developers.google.com/web/tools/workbox/" target="_blank" rel="noopener">Workbox Service Worker</a> —— 我们可以使用Google的Workbox项目为我们创建一个<a href="http://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener">Service Worker</a> ，了解我们项目的所有东西[这句翻译的有点问题，可以看原文理解]。PWA，我们来了！</p>
</li>
<li><p><a href="http://postcss.org/" target="_blank" rel="noopener">PostCSS</a> —— 我认为它是“css的babel”，像sass和scss都是基于它来构建，它让你可以使用即将推出的css功能。</p>
</li>
<li><p><a href="http://images.guide/" target="_blank" rel="noopener">Image Optimization</a> —— 目前，图片仍然是大部分网页呈现的主要内容，所以可以通过<code>mozjpeg</code>，<code>optipng</code>，<code>svgo</code>等自动化工具来压缩优化图片资源是很有必要的。</p>
</li>
<li><p><a href="http://developers.google.com/speed/webp/" target="_blank" rel="noopener">Automatic .webp Creation</a> —— Chrome、Edge和FireFox都支持.webp文件，它比jpeg体积更小，节省资源。</p>
</li>
<li><p><a href="http://vuejs.org/" target="_blank" rel="noopener">VueJS</a> —— VueJs是我这次用的前端框架，我希望能够通过单个文件<code>.vue</code>组件作为开发过程的一部分。</p>
</li>
<li><p><a href="http://tailwindcss.com/docs/what-is-tailwind/" target="_blank" rel="noopener">Tailwind CSS</a> —— Tailwind是一个实用程序优先的css，我用它在本地开发中快速进行原型设计，然后通过PurgeCss进行生产，从而减小体积。</p>
</li>
</ul>
<p>哇，看起来相当丰富的清单！</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/11/10/166fd86a65ffe9ba?w=1200&amp;h=675&amp;f=png&amp;s=714693" alt=""></p>
<p>还有很多东西，比如JavaScript自动化、css压缩以及其他标准配置，去构建我们期望的前端系统。</p>
<p>我还希望它可以给开发团队使用，开发团队可以使用不同的工具应用在他们的本地开发环境，并使配置易于维护以及可以被其他项目重用。</p>
<blockquote>
<p>The importance of maintainability and reusability can’t be understated [可维护性和复用性是非常重要的。]</p>
</blockquote>
<p>你使用的前端框架或者技术栈可以跟我的不一样，但应用的规则其实是相同的，所以请继续阅读其余部分，不管你用的是什么技术栈！</p>
<h2 id="PROJECT-TREE-amp-ORGANIZATION"><a href="#PROJECT-TREE-amp-ORGANIZATION" class="headerlink" title="PROJECT TREE &amp; ORGANIZATION"></a>PROJECT TREE &amp; ORGANIZATION</h2><p>为了让你了解程序的整体架构，这里展示一个简单的项目树：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">├── example.env</span><br><span class="line">├── package.json</span><br><span class="line">├── postcss.config.js</span><br><span class="line">├── src</span><br><span class="line">│   ├── css</span><br><span class="line">│   │   ├── app.pcss</span><br><span class="line">│   │   ├── components</span><br><span class="line">│   │   │   ├── global.pcss</span><br><span class="line">│   │   │   ├── typography.pcss</span><br><span class="line">│   │   │   └── webfonts.pcss</span><br><span class="line">│   │   ├── pages</span><br><span class="line">│   │   │   └── homepage.pcss</span><br><span class="line">│   │   └── vendor.pcss</span><br><span class="line">│   ├── fonts</span><br><span class="line">│   ├── img</span><br><span class="line">│   │   └── favicon-src.png</span><br><span class="line">│   ├── js</span><br><span class="line">│   │   ├── app.js</span><br><span class="line">│   │   └── workbox-catch-handler.js</span><br><span class="line">│   └── vue</span><br><span class="line">│       └── Confetti.vue</span><br><span class="line">├── tailwind.config.js</span><br><span class="line">├── templates</span><br><span class="line">├── webpack.common.js</span><br><span class="line">├── webpack.dev.js</span><br><span class="line">├── webpack.prod.js</span><br><span class="line">├── webpack.settings.js</span><br><span class="line">└── yarn.lock</span><br></pre></td></tr></table></figure>
<p>完整的代码可以查看: <a href="http://github.com/nystudio107/annotated-webpack-4-config" target="_blank" rel="noopener">annotated-webpack-4-config</a></p>
<p>在核心配置文件方法，包括：</p>
<ul>
<li><p><code>.env</code>—— webpack-dev-server特定于开发环境的设置，不需要在git中检查</p>
</li>
<li><p><code>webpack.settings.js</code> —— 一个JSON-ish设置文件，我们需要在项目之间编辑的唯一文件</p>
</li>
<li><p><code>webpack.common.js</code> —— 相同类型的构建放在统一设置文件</p>
</li>
<li><p><code>webpack.dev.js</code> —— 设置本地开发各个构建</p>
</li>
<li><p><code>webpack.prod.js</code> —— 设置生产环境各个构建</p>
</li>
</ul>
<p>这是一个如何将以上配置组合成的图表：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/11/20/1673059d3cf516a9?w=992&amp;h=1315&amp;f=png&amp;s=287267" alt=""></p>
<p>目标是你只需要编辑项目之间的金色圆角区域（<code>.env</code>&amp;<code>webpack.settings.js</code>）。</p>
<p>以这种形式分离出来使得配置文件使用变得更加容易，即使你最终修改了我原先提供的各种webpack配置文件，但保持这种方式有助于你长期去对配置文件进行维护。</p>
<p>别着急，我们等下会详细介绍每个文件。</p>
<h2 id="ANNOTATED-PACKAGE-JSON"><a href="#ANNOTATED-PACKAGE-JSON" class="headerlink" title="ANNOTATED PACKAGE.JSON"></a>ANNOTATED PACKAGE.JSON</h2><p>让我们从修改我们的<code>package.json</code>开始入手：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;example-project&quot;,</span><br><span class="line">    &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;Example Project brand website&quot;,</span><br><span class="line">    &quot;keywords&quot;: [</span><br><span class="line">        &quot;Example&quot;,</span><br><span class="line">        &quot;Keywords&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;homepage&quot;: &quot;https://github.com/example-developer/example-project&quot;,</span><br><span class="line">    &quot;bugs&quot;: &#123;</span><br><span class="line">        &quot;email&quot;: &quot;someone@example-developer.com&quot;,</span><br><span class="line">        &quot;url&quot;: &quot;https://github.com/example-developer/example-project/issues&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;license&quot;: &quot;SEE LICENSE IN LICENSE.md&quot;,</span><br><span class="line">    &quot;author&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Example Developer&quot;,</span><br><span class="line">        &quot;email&quot;: &quot;someone@example-developer.com&quot;,</span><br><span class="line">        &quot;url&quot;: &quot;https://example-developer.com&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;browser&quot;: &quot;/web/index.php&quot;,</span><br><span class="line">    &quot;repository&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;git&quot;,</span><br><span class="line">        &quot;url&quot;: &quot;git+https://github.com/example-developer/example-project.git&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;private&quot;: true,</span><br></pre></td></tr></table></figure>
<p>这里没什么有趣的东西，只是包含了我们网站的元信息，就像<code>package.json</code><a href="https://docs.npmjs.com/files/package.json" target="_blank" rel="noopener">规范</a>中所述。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;dev&quot;: &quot;webpack-dev-server --config webpack.dev.js&quot;,</span><br><span class="line">    &quot;build&quot;: &quot;webpack --config webpack.prod.js --progress --hide-modules&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>上述脚本代表了我们为项目提供的两个主要构建步骤：</p>
<ul>
<li><p><code>dev</code> —— 只要我们修改了项目的代码，启动该配置后，它会使用webpack-dev-server来实现热模块替换（HMR），内存编译以及其他细节处理。</p>
</li>
<li><p><code>build</code> —— 当我们进行生产部署时，它会执行所有花哨以及耗时的事情，例如Critical CSS、JavaScript压缩等。</p>
</li>
</ul>
<p>我们只需要在命令行执行以下操作：<br>如果我们使用的是<code>yarn</code>，输入<code>yarn dev</code>或者<code>yarn build</code>；如果使用的是npm，输入<code>npm run dev</code>或者<code>npm run build</code>。这些是你唯一需要使用的两个命令。</p>
<p>请注意，不仅可以通过<code>--config</code>配置，我们还可以传入<a href="https://webpack.js.org/guides/production/" target="_blank" rel="noopener">单独的配置文件</a>进行配置。这样我们可以将webpack配置分解为单独的逻辑文件，因为与生产环境构建相比，我们将为开发环境的构建做很多不同的事情。</p>
<p>接下来我们的<strong>browserslist</strong>配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&quot;browserslist&quot;: &#123;</span><br><span class="line">        &quot;production&quot;: [</span><br><span class="line">            &quot;&gt; 1%&quot;,</span><br><span class="line">            &quot;last 2 versions&quot;,</span><br><span class="line">            &quot;Firefox ESR&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;legacyBrowsers&quot;: [</span><br><span class="line">            &quot;&gt; 1%&quot;,</span><br><span class="line">            &quot;last 2 versions&quot;,</span><br><span class="line">            &quot;Firefox ESR&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;modernBrowsers&quot;: [</span><br><span class="line">            &quot;last 2 Chrome versions&quot;,</span><br><span class="line">            &quot;not Chrome &lt; 60&quot;,</span><br><span class="line">            &quot;last 2 Safari versions&quot;,</span><br><span class="line">            &quot;not Safari &lt; 10.1&quot;,</span><br><span class="line">            &quot;last 2 iOS versions&quot;,</span><br><span class="line">            &quot;not iOS &lt; 10.3&quot;,</span><br><span class="line">            &quot;last 2 Firefox versions&quot;,</span><br><span class="line">            &quot;not Firefox &lt; 54&quot;,</span><br><span class="line">            &quot;last 2 Edge versions&quot;,</span><br><span class="line">            &quot;not Edge &lt; 15&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>这是一个基于人类可读配置的特定<a href="https://github.com/browserslist/browserslist" target="_blank" rel="noopener">浏览器列表</a>，<code>PostCSS autoprefixer</code>默认使用在<code>production</code>设置中，我们将<code>legacyBrowsers</code>和<code>modernBrowsers</code>传递给<code>Babel</code>用来处理传统[过去]和现代js包的构建[处理转码问题，兼容es6等写法]，后面会有详细介绍。</p>
<p>接着是<strong>devDependencies</strong>，它是构建系统所需的所有npm包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&quot;devDependencies&quot;: &#123;</span><br><span class="line">        &quot;@babel/core&quot;: &quot;^7.1.0&quot;,</span><br><span class="line">        &quot;@babel/plugin-syntax-dynamic-import&quot;: &quot;^7.0.0&quot;,</span><br><span class="line">        &quot;@babel/plugin-transform-runtime&quot;: &quot;^7.1.0&quot;,</span><br><span class="line">        &quot;@babel/preset-env&quot;: &quot;^7.1.0&quot;,</span><br><span class="line">        &quot;@babel/register&quot;: &quot;^7.0.0&quot;,</span><br><span class="line">        &quot;@babel/runtime&quot;: &quot;^7.0.0&quot;,</span><br><span class="line">        &quot;autoprefixer&quot;: &quot;^9.1.5&quot;,</span><br><span class="line">        &quot;babel-loader&quot;: &quot;^8.0.2&quot;,</span><br><span class="line">        &quot;clean-webpack-plugin&quot;: &quot;^0.1.19&quot;,</span><br><span class="line">        &quot;copy-webpack-plugin&quot;: &quot;^4.5.2&quot;,</span><br><span class="line">        &quot;create-symlink-webpack-plugin&quot;: &quot;^1.0.0&quot;,</span><br><span class="line">        &quot;critical&quot;: &quot;^1.3.4&quot;,</span><br><span class="line">        &quot;critical-css-webpack-plugin&quot;: &quot;^0.2.0&quot;,</span><br><span class="line">        &quot;css-loader&quot;: &quot;^1.0.0&quot;,</span><br><span class="line">        &quot;cssnano&quot;: &quot;^4.1.0&quot;,</span><br><span class="line">        &quot;dotenv&quot;: &quot;^6.1.0&quot;,</span><br><span class="line">        &quot;file-loader&quot;: &quot;^2.0.0&quot;,</span><br><span class="line">        &quot;git-rev-sync&quot;: &quot;^1.12.0&quot;,</span><br><span class="line">        &quot;glob-all&quot;: &quot;^3.1.0&quot;,</span><br><span class="line">        &quot;html-webpack-plugin&quot;: &quot;^3.2.0&quot;,</span><br><span class="line">        &quot;ignore-loader&quot;: &quot;^0.1.2&quot;,</span><br><span class="line">        &quot;imagemin&quot;: &quot;^6.0.0&quot;,</span><br><span class="line">        &quot;imagemin-gifsicle&quot;: &quot;^5.2.0&quot;,</span><br><span class="line">        &quot;imagemin-mozjpeg&quot;: &quot;^7.0.0&quot;,</span><br><span class="line">        &quot;imagemin-optipng&quot;: &quot;^5.2.1&quot;,</span><br><span class="line">        &quot;imagemin-svgo&quot;: &quot;^7.0.0&quot;,</span><br><span class="line">        &quot;imagemin-webp&quot;: &quot;^4.1.0&quot;,</span><br><span class="line">        &quot;imagemin-webp-webpack-plugin&quot;: &quot;^1.0.2&quot;,</span><br><span class="line">        &quot;img-loader&quot;: &quot;^3.0.1&quot;,</span><br><span class="line">        &quot;mini-css-extract-plugin&quot;: &quot;^0.4.3&quot;,</span><br><span class="line">        &quot;moment&quot;: &quot;^2.22.2&quot;,</span><br><span class="line">        &quot;optimize-css-assets-webpack-plugin&quot;: &quot;^5.0.1&quot;,</span><br><span class="line">        &quot;postcss&quot;: &quot;^7.0.2&quot;,</span><br><span class="line">        &quot;postcss-extend&quot;: &quot;^1.0.5&quot;,</span><br><span class="line">        &quot;postcss-hexrgba&quot;: &quot;^1.0.1&quot;,</span><br><span class="line">        &quot;postcss-import&quot;: &quot;^12.0.0&quot;,</span><br><span class="line">        &quot;postcss-loader&quot;: &quot;^3.0.0&quot;,</span><br><span class="line">        &quot;postcss-nested&quot;: &quot;^4.1.0&quot;,</span><br><span class="line">        &quot;postcss-nested-ancestors&quot;: &quot;^2.0.0&quot;,</span><br><span class="line">        &quot;postcss-simple-vars&quot;: &quot;^5.0.1&quot;,</span><br><span class="line">        &quot;purgecss-webpack-plugin&quot;: &quot;^1.3.0&quot;,</span><br><span class="line">        &quot;purgecss-whitelister&quot;: &quot;^2.2.0&quot;,</span><br><span class="line">        &quot;resolve-url-loader&quot;: &quot;^3.0.0&quot;,</span><br><span class="line">        &quot;sane&quot;: &quot;^4.0.1&quot;,</span><br><span class="line">        &quot;save-remote-file-webpack-plugin&quot;: &quot;^1.0.0&quot;,</span><br><span class="line">        &quot;style-loader&quot;: &quot;^0.23.0&quot;,</span><br><span class="line">        &quot;symlink-webpack-plugin&quot;: &quot;^0.0.4&quot;,</span><br><span class="line">        &quot;terser-webpack-plugin&quot;: &quot;^1.1.0&quot;,</span><br><span class="line">        &quot;vue-loader&quot;: &quot;^15.4.2&quot;,</span><br><span class="line">        &quot;vue-style-loader&quot;: &quot;^4.1.2&quot;,</span><br><span class="line">        &quot;vue-template-compiler&quot;: &quot;^2.5.17&quot;,</span><br><span class="line">        &quot;webapp-webpack-plugin&quot;: &quot;https://github.com/brunocodutra/webapp-webpack-plugin.git&quot;,</span><br><span class="line">        &quot;webpack&quot;: &quot;^4.19.1&quot;,</span><br><span class="line">        &quot;webpack-bundle-analyzer&quot;: &quot;^3.0.2&quot;,</span><br><span class="line">        &quot;webpack-cli&quot;: &quot;^3.1.1&quot;,</span><br><span class="line">        &quot;webpack-dashboard&quot;: &quot;^2.0.0&quot;,</span><br><span class="line">        &quot;webpack-dev-server&quot;: &quot;^3.1.9&quot;,</span><br><span class="line">        &quot;webpack-manifest-plugin&quot;: &quot;^2.0.4&quot;,</span><br><span class="line">        &quot;webpack-merge&quot;: &quot;^4.1.4&quot;,</span><br><span class="line">        &quot;webpack-notifier&quot;: &quot;^1.6.0&quot;,</span><br><span class="line">        &quot;workbox-webpack-plugin&quot;: &quot;^3.6.2&quot;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>没错，这里面依赖了很多npm包，但我们的构建过程确实做的事情需要用到它们。</p>
<p>最后，<strong>dependencies</strong>的使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;dependencies&quot;: &#123;</span><br><span class="line">        &quot;@babel/polyfill&quot;: &quot;^7.0.0&quot;,</span><br><span class="line">        &quot;axios&quot;: &quot;^0.18.0&quot;,</span><br><span class="line">        &quot;tailwindcss&quot;: &quot;^0.6.6&quot;,</span><br><span class="line">        &quot;vue&quot;: &quot;^2.5.17&quot;,</span><br><span class="line">        &quot;vue-confetti&quot;: &quot;^0.4.2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然，对于一个真实存在的网站或者应用，<strong>dependencies</strong>中会有更多npm包，但我们现在专注于构建过程。</p>
<h2 id="ANNOTATED-WEBPACK-SETTINGS-JS"><a href="#ANNOTATED-WEBPACK-SETTINGS-JS" class="headerlink" title="ANNOTATED WEBPACK.SETTINGS.JS"></a>ANNOTATED WEBPACK.SETTINGS.JS</h2><p>我还使用了我在<a href="https://nystudio107.com/blog/a-better-package-json-for-the-frontend" target="_blank" rel="noopener"> A Bet­ter package.json for the Fron­tend arti­cle</a>一文中讨论过的类似方法，为了封锁从项目之间配置变为单独的<code>webpack.settings.js</code>，并保持webpack配置本身不变。</p>
<blockquote>
<p>The key concept is that the only file we need to edit from project to project is the webpack.settings.js. [关键概念是我们需要在项目之间编辑的唯一文件是webpack.settings.js]</p>
</blockquote>
<p>由于大部分项目都有一些非常相似的事情需要完成，所以我们可以创建一个适用于各个项目的webpack配置，我们只需要更改它所操作的数据。</p>
<p>因此，在我们的<code>webpack.settings.js</code>配置文件中的内容（从项目到项目的数据）和webpack配置中的内容（如何操作这些数据产生最终结果）之间的关注点分离。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">// webpack.settings.js - webpack settings config</span><br><span class="line"></span><br><span class="line">// node modules</span><br><span class="line">require(&apos;dotenv&apos;).config();</span><br><span class="line"></span><br><span class="line">// Webpack settings exports</span><br><span class="line">// noinspection WebpackConfigHighlighting</span><br><span class="line">module.exports = &#123;</span><br><span class="line">    name: &quot;Example Project&quot;,</span><br><span class="line">    copyright: &quot;Example Company, Inc.&quot;,</span><br><span class="line">    paths: &#123;</span><br><span class="line">        src: &#123;</span><br><span class="line">            base: &quot;./src/&quot;,</span><br><span class="line">            css: &quot;./src/css/&quot;,</span><br><span class="line">            js: &quot;./src/js/&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        dist: &#123;</span><br><span class="line">            base: &quot;./web/dist/&quot;,</span><br><span class="line">            clean: [</span><br><span class="line">                &quot;./img&quot;,</span><br><span class="line">                &quot;./criticalcss&quot;,</span><br><span class="line">                &quot;./css&quot;,</span><br><span class="line">                &quot;./js&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        templates: &quot;./templates/&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    urls: &#123;</span><br><span class="line">        live: &quot;https://example.com/&quot;,</span><br><span class="line">        local: &quot;http://example.test/&quot;,</span><br><span class="line">        critical: &quot;http://example.test/&quot;,</span><br><span class="line">        publicPath: &quot;/dist/&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    vars: &#123;</span><br><span class="line">        cssName: &quot;styles&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    entries: &#123;</span><br><span class="line">        &quot;app&quot;: &quot;app.js&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    copyWebpackConfig: [</span><br><span class="line">        &#123;</span><br><span class="line">            from: &quot;./src/js/workbox-catch-handler.js&quot;,</span><br><span class="line">            to: &quot;js/[name].[ext]&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    criticalCssConfig: &#123;</span><br><span class="line">        base: &quot;./web/dist/criticalcss/&quot;,</span><br><span class="line">        suffix: &quot;_critical.min.css&quot;,</span><br><span class="line">        criticalHeight: 1200,</span><br><span class="line">        criticalWidth: 1200,</span><br><span class="line">        ampPrefix: &quot;amp_&quot;,</span><br><span class="line">        ampCriticalHeight: 19200,</span><br><span class="line">        ampCriticalWidth: 600,</span><br><span class="line">        pages: [</span><br><span class="line">            &#123;</span><br><span class="line">                url: &quot;&quot;,</span><br><span class="line">                template: &quot;index&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    devServerConfig: &#123;</span><br><span class="line">        public: () =&gt; process.env.DEVSERVER_PUBLIC || &quot;http://localhost:8080&quot;,</span><br><span class="line">        host: () =&gt; process.env.DEVSERVER_HOST || &quot;localhost&quot;,</span><br><span class="line">        poll: () =&gt; process.env.DEVSERVER_POLL || false,</span><br><span class="line">        port: () =&gt; process.env.DEVSERVER_PORT || 8080,</span><br><span class="line">        https: () =&gt; process.env.DEVSERVER_HTTPS || false,</span><br><span class="line">    &#125;,</span><br><span class="line">    manifestConfig: &#123;</span><br><span class="line">        basePath: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    purgeCssConfig: &#123;</span><br><span class="line">        paths: [</span><br><span class="line">            &quot;./templates/**/*.&#123;twig,html&#125;&quot;,</span><br><span class="line">            &quot;./src/vue/**/*.&#123;vue,html&#125;&quot;</span><br><span class="line">        ],</span><br><span class="line">        whitelist: [</span><br><span class="line">            &quot;./src/css/components/**/*.&#123;css,pcss&#125;&quot;</span><br><span class="line">        ],</span><br><span class="line">        whitelistPatterns: [],</span><br><span class="line">        extensions: [</span><br><span class="line">            &quot;html&quot;,</span><br><span class="line">            &quot;js&quot;,</span><br><span class="line">            &quot;twig&quot;,</span><br><span class="line">            &quot;vue&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    saveRemoteFileConfig: [</span><br><span class="line">        &#123;</span><br><span class="line">            url: &quot;https://www.google-analytics.com/analytics.js&quot;,</span><br><span class="line">            filepath: &quot;js/analytics.js&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    createSymlinkConfig: [</span><br><span class="line">        &#123;</span><br><span class="line">            origin: &quot;img/favicons/favicon.ico&quot;,</span><br><span class="line">            symlink: &quot;../favicon.ico&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    webappConfig: &#123;</span><br><span class="line">        logo: &quot;./src/img/favicon-src.png&quot;,</span><br><span class="line">        prefix: &quot;img/favicons/&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    workboxConfig: &#123;</span><br><span class="line">        swDest: &quot;../sw.js&quot;,</span><br><span class="line">        precacheManifestFilename: &quot;js/precache-manifest.[manifestHash].js&quot;,</span><br><span class="line">        importScripts: [</span><br><span class="line">            &quot;/dist/workbox-catch-handler.js&quot;</span><br><span class="line">        ],</span><br><span class="line">        exclude: [</span><br><span class="line">            /\.(png|jpe?g|gif|svg|webp)$/i,</span><br><span class="line">            /\.map$/,</span><br><span class="line">            /^manifest.*\\.js(?:on)?$/,</span><br><span class="line">        ],</span><br><span class="line">        globDirectory: &quot;./web/&quot;,</span><br><span class="line">        globPatterns: [</span><br><span class="line">            &quot;offline.html&quot;,</span><br><span class="line">            &quot;offline.svg&quot;</span><br><span class="line">        ],</span><br><span class="line">        offlineGoogleAnalytics: true,</span><br><span class="line">        runtimeCaching: [</span><br><span class="line">            &#123;</span><br><span class="line">                urlPattern: /\.(?:png|jpg|jpeg|svg|webp)$/,</span><br><span class="line">                handler: &quot;cacheFirst&quot;,</span><br><span class="line">                options: &#123;</span><br><span class="line">                    cacheName: &quot;images&quot;,</span><br><span class="line">                    expiration: &#123;</span><br><span class="line">                        maxEntries: 20</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们将在webpack配置部分介绍所有内容，这里需要注意的重点是，我们已经采取了从项目到项目的更改，并加其从我们的webpack配置文件中分离出来，并添加到单独的<code>webpack.settings.js</code>文件中。</p>
<p>这意味着我们可以在<code>webpack.settings.js</code>配置文件中定义每个项目不同的地方，而不需要与webpack本身配置进行掺和在一起。尽管<code>webpack.settings.js</code>文件是一个js文件，但我尽量将它保持为JSON-ish，所以我们只是更改其中的简单设置，我没有使用JSON作为文件格式的灵活性，也允许添加注释。</p>
<h2 id="COMMON-CONVENTIONS-FOR-WEBPACK-CONFIGS"><a href="#COMMON-CONVENTIONS-FOR-WEBPACK-CONFIGS" class="headerlink" title="COMMON CONVENTIONS FOR WEBPACK CONFIGS"></a>COMMON CONVENTIONS FOR WEBPACK CONFIGS</h2><p>我为所有webpack配置文件（<code>webpack.common.js</code>，<code>webpack.dev.js</code>和<code>webpack.prod.js</code>）采用了一些约定，让它们看起来比较一致。</p>
<p>每个配置文件都有两个内置配置：</p>
<ul>
<li><p><strong>legacyConfig</strong> —— 适用于旧版ES5构建的配置</p>
</li>
<li><p><strong>modernConfig</strong> —— 适用于构建现代ES2015+版本的配置</p>
<p>我们这样做是因为我们有单独的配置来创建兼容旧版本与现代构建，使它们在逻辑独立。<code>webpack.common.js</code> 也有一个<strong>baseConfig</strong>，为了保证组织的纯粹。</p>
</li>
</ul>
<p>可以把它想象成面向对象编程，其中各种配置项目继承，<strong>baseConfig</strong>作为根对象。</p>
<p>为了保证配置简洁清晰和具有可读性，采用的另一个约定是为各种webpack插件和需要配置的其他webpack片段配置configure()函数，而不是全部混在一起。</p>
<p>这样做是因为在<code>webpack.settings.js</code>中的一些数据需要在使用webpack之前进行转换，并且由于过去/现代构建，我们需要根据构建类型返回不同的配置。</p>
<p>它还使配置文件更具可读性。</p>
<p>作为一个通用的webpack概念，要知道webpack本身只知道如何加载JavaScript和JSON。要加载其他东西，需要使用对应的<a href="https://webpack.js.org/concepts/#loaders" target="_blank" rel="noopener">加载器</a>，我们将在webpack配置中使用许多不同的加载器。</p>
<h2 id="ANNOTATED-WEBPACK-COMMON-JS"><a href="#ANNOTATED-WEBPACK-COMMON-JS" class="headerlink" title="ANNOTATED WEBPACK.COMMON.JS"></a>ANNOTATED WEBPACK.COMMON.JS</h2><p>现在让我们看一下<code>webpack.common.js</code>配置文件，包含<code>dev</code>和<code>prod</code>构建类型间共享的所有配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// webpack.common.js - common webpack config</span><br><span class="line">const LEGACY_CONFIG = &apos;legacy&apos;;</span><br><span class="line">const MODERN_CONFIG = &apos;modern&apos;;</span><br><span class="line"></span><br><span class="line">// node modules</span><br><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const merge = require(&apos;webpack-merge&apos;);</span><br><span class="line"></span><br><span class="line">// webpack plugins</span><br><span class="line">const CopyWebpackPlugin = require(&apos;copy-webpack-plugin&apos;);</span><br><span class="line">const ManifestPlugin = require(&apos;webpack-manifest-plugin&apos;);</span><br><span class="line">const VueLoaderPlugin = require(&apos;vue-loader/lib/plugin&apos;);</span><br><span class="line">const WebpackNotifierPlugin = require(&apos;webpack-notifier&apos;);</span><br><span class="line"></span><br><span class="line">// config files</span><br><span class="line">const pkg = require(&apos;./package.json&apos;);</span><br><span class="line">const settings = require(&apos;./webpack.settings.js&apos;);</span><br></pre></td></tr></table></figure>
<p> 在一开始，我们引入了我们需要的node包，以及需要使用的webpack插件。然后我们导入<code>webpack.settings.js</code> 作为<code>settings</code>，以便我们可以访问那里的设置，并将<code>package.json</code>作为<code>pkg</code>导入，对其进行访问。</p>
<h2 id="CONFIGURATION-FUNCTIONS"><a href="#CONFIGURATION-FUNCTIONS" class="headerlink" title="CONFIGURATION FUNCTIONS"></a>CONFIGURATION FUNCTIONS</h2><p> 这是<code>configureBabelLoader()</code>的设置：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> // Configure Babel loader</span><br><span class="line">const configureBabelLoader = (browserList) =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        test: /\.js$/,</span><br><span class="line">        exclude: /node_modules/,</span><br><span class="line">        use: &#123;</span><br><span class="line">            loader: &apos;babel-loader&apos;,</span><br><span class="line">            options: &#123;</span><br><span class="line">                presets: [</span><br><span class="line">                    [</span><br><span class="line">                        &apos;@babel/preset-env&apos;, &#123;</span><br><span class="line">                        modules: false,</span><br><span class="line">                        useBuiltIns: &apos;entry&apos;,</span><br><span class="line">                        targets: &#123;</span><br><span class="line">                            browsers: browserList,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;</span><br><span class="line">                    ],</span><br><span class="line">                ],</span><br><span class="line">                plugins: [</span><br><span class="line">                    &apos;@babel/plugin-syntax-dynamic-import&apos;,</span><br><span class="line">                    [</span><br><span class="line">                        &quot;@babel/plugin-transform-runtime&quot;, &#123;</span><br><span class="line">                        &quot;regenerator&quot;: true</span><br><span class="line">                    &#125;</span><br><span class="line">                    ]</span><br><span class="line">                ],</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 函数<code>configureBabelLoader()</code>配置<code>babel-loader</code>来处理所有<code>js</code>后缀文件的加载，它使用<a href="https://babeljs.io/docs/en/babel-preset-env" target="_blank" rel="noopener">@babel/preset-env</a>而不是<code>.babelrc</code>文件，因此我们可以把所以内容保留在webpack配置文件中。</p>
<p> Babel可以将现代ES2015+（以及其他许多语言，如TypeScript或CoffeeScript）编译为针对特定浏览器或标准的JavaScript。我们将<code>browserList</code>作为参数传入，这样我们可以为旧版浏览器构建现代ES2015+模块和用polyfills兼容旧版ES5。</p>
<p> 在我们的HTML中，我们只做这样的事情：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &lt;!-- Browsers with ES module support load this file. --&gt;</span><br><span class="line">&lt;script type=&quot;module&quot; src=&quot;main.js&quot;&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Older browsers load this file (and module-supporting --&gt;</span><br><span class="line">&lt;!-- browsers know *not* to load this file). --&gt;</span><br><span class="line">&lt;script nomodule src=&quot;main-legacy.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p> 不用polyfills，不用大惊小怪，旧版浏览器忽略<code>type=&quot;module&quot;</code>脚本，并获取<code>main-legacy.js</code>，新版浏览器加载<code>main.js</code>，忽略<code>nomodule</code>，看起来很棒，真庆幸我想出了这个想法！为了不让你觉得这种方法是极端，<a href="http://medium.com/the-vue-point/vue-cli-3-0-is-here-c42bebe28fbb" target="_blank" rel="noopener"><code>vue-cli</code>在版本3中采用了这种策略</a>。</p>
<p> <a href="https://babeljs.io/docs/en/babel-plugin-syntax-dynamic-import" target="_blank" rel="noopener">@ babel/plugin-syntax-dynamic-import</a>插件甚至可以在web浏览器实现<a href="https://github.com/tc39/proposal-dynamic-import" target="_blank" rel="noopener">ECMAScripr动态导入</a>之前进行动态导入，这使我们可以<a href="https://webpack.js.org/guides/code-splitting/#dynamic-imports" target="_blank" rel="noopener">异步加载我们的JavaScript模块，并根据需要动态加载</a>。</p>
<p> 那么到底在说啥？这意味着我们可以做这样的事：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> // App main</span><br><span class="line">const main = async () =&gt; &#123;</span><br><span class="line">    // Async load the vue module</span><br><span class="line">    const Vue = await import(/* webpackChunkName: &quot;vue&quot; */ &apos;vue&apos;);</span><br><span class="line">    // Create our vue instance</span><br><span class="line">    const vm = new Vue.default(&#123;</span><br><span class="line">        el: &quot;#app&quot;,</span><br><span class="line">        components: &#123;</span><br><span class="line">            &apos;confetti&apos;: () =&gt; import(/* webpackChunkName: &quot;confetti&quot; */ &apos;../vue/Confetti.vue&apos;),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">// Execute async function</span><br><span class="line">main().then( (value) =&gt; &#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p> 有两点：</p>
<p> 1、通过<code>/* webpackChunkName: &quot;vue&quot; */</code>，我们告诉webpack希望这个动态代码拆分块被命名。</p>
<p> 2、由于我们在异步函数（“main”）中使用<code>import()</code>，该函数等待动态加载的JavaScript导入的结果，而其余的代码以其方式继续。</p>
<p> 我们已经有效地告诉webpack，我们希望我们的块通过代码分割，而不是通过配置，通过<code>@babel/plugin-syntax-dynamic-import</code>的自带魔法，可以根据需要异步加载此JavaScript块。</p>
<p> 注意，我们也是使用<code>.vue</code>单文件组件做了同样的操作，很好。</p>
<p> 除了使用<code>await</code>，我们也可以在<code>import()</code>Promise返回后执行我们的代码：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> // Async load the vue module</span><br><span class="line">import(/* webpackChunkName: &quot;vue&quot; */ &apos;vue&apos;).then(Vue =&gt; &#123;</span><br><span class="line">    // Vue has loaded, do something with it</span><br><span class="line">    // Create our vue instance</span><br><span class="line">    const vm = new Vue.default(&#123;</span><br><span class="line">        el: &quot;#app&quot;,</span><br><span class="line">        components: &#123;</span><br><span class="line">            &apos;confetti&apos;: () =&gt; import(/* webpackChunkName: &quot;confetti&quot; */ &apos;../vue/Confetti.vue&apos;),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p> 这里我们使用了Promise，而不是<code>await</code>，因此我们知道动态导入已经成功并且可以愉快地使用<code>Vue</code>。</p>
<p> 如果你足够仔细，你可以看到我们通过Promises有效地解决了JavaScript依赖关系，太棒了！</p>
<p> 我们甚至可以在用户点击了某些内容，滚动到某个位置或者满足其他条件后去加载某些JavaScript快等有趣的事情。</p>
<p> 查看更多关于<a href="http://webpack.js.org/api/module-methods/#import-" target="_blank" rel="noopener">Module Methods import()</a>信息。</p>
<p> 如果你有兴趣了解更多有关Babel的信息，可以查看<a href="https://www.thebasement.be/working-with-babel-7-and-webpack/" target="_blank" rel="noopener">Working with Babel 7 and Webpack</a>这篇文章。</p>
<p> 接下来我们有<code>configureEntries()</code>：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> // Configure Entries</span><br><span class="line">const configureEntries = () =&gt; &#123;</span><br><span class="line">    let entries = &#123;&#125;;</span><br><span class="line">    for (const [key, value] of Object.entries(settings.entries)) &#123;</span><br><span class="line">        entries[key] = path.resolve(__dirname, settings.paths.src.js + value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return entries;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 这里我们通过<code>swttings.entries</code>从<code>webpack.settings.js</code>中拿到webpack <a href="http://webpack.js.org/concepts/entry-points/" target="_blank" rel="noopener">entry</a>，对于<a href="https://medium.com/@pshrmn/demystifying-single-page-applications-3068d0555d46" target="_blank" rel="noopener">单页应用</a>（SPA），只存在一个entry。对于更传统的网站，你可能有几个entry（每页模版可能有一个entry）。</p>
<p> 无论哪种方式，由于我们已经在<code>webpack.settings.js</code>中定义了entry points，所以很容易在文件对其进行配置，entry points实际上只是一个<code>&lt;script src =“app.js”&gt; &lt;/ script&gt;</code>标记，你将在HTML中包含该标记以引入JavaScript。</p>
<p> 由于我们使用的是动态导入模块，因此我们通常在页面上只有一个<code>&lt;script&gt;&lt;/script&gt;</code>标签；其余的JavaScript会根据需要动态加载。</p>
<p> 接下来我们有<code>configureFontLoader()</code>函数：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> // Configure Font loader</span><br><span class="line">const configureFontLoader = () =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        test: /\.(ttf|eot|woff2?)$/i,</span><br><span class="line">        use: [</span><br><span class="line">            &#123;</span><br><span class="line">                loader: &apos;file-loader&apos;,</span><br><span class="line">                options: &#123;</span><br><span class="line">                    name: &apos;fonts/[name].[ext]&apos;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> <code>dev</code>和<code>prod</code>构建字体加载是相同的，所以我们把它写在这里，对于我们使用的任何本地字体，我们可以通知webpack在JavaScript中加载它们：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import comicsans from &apos;../fonts/ComicSans.woff2&apos;;</span><br></pre></td></tr></table></figure>
<p> 接下来我们有<code>configureManifest()</code>函数：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> // Configure Manifest</span><br><span class="line">const configureManifest = (fileName) =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        fileName: fileName,</span><br><span class="line">        basePath: settings.manifestConfig.basePath,</span><br><span class="line">        map: (file) =&gt; &#123;</span><br><span class="line">            file.name = file.name.replace(/(\.[a-f0-9]&#123;32&#125;)(\..*)$/, &apos;$2&apos;);</span><br><span class="line">            return file;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 这会为基于文件名的缓存清除配置<a href="http://github.com/danethurber/webpack-manifest-plugin" target="_blank" rel="noopener">webpack-manifest-plugin</a>，简单来说，webpack知道我们需要的所有JavaScript、css和其他资源，所以它可以生成一个指向带哈希命名的资源清单，例如：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">  &quot;vendors~confetti~vue.js&quot;: &quot;/dist/js/vendors~confetti~vue.03b9213ce186db5518ea.js&quot;,</span><br><span class="line">  &quot;vendors~confetti~vue.js.map&quot;: &quot;/dist/js/vendors~confetti~vue.03b9213ce186db5518ea.js.map&quot;,</span><br><span class="line">  &quot;app.js&quot;: &quot;/dist/js/app.30334b5124fa6e221464.js&quot;,</span><br><span class="line">  &quot;app.js.map&quot;: &quot;/dist/js/app.30334b5124fa6e221464.js.map&quot;,</span><br><span class="line">  &quot;confetti.js&quot;: &quot;/dist/js/confetti.1152197f8c58a1b40b34.js&quot;,</span><br><span class="line">  &quot;confetti.js.map&quot;: &quot;/dist/js/confetti.1152197f8c58a1b40b34.js.map&quot;,</span><br><span class="line">  &quot;js/precache-manifest.js&quot;: &quot;/dist/js/precache-manifest.f774c437974257fc8026ca1bc693655c.js&quot;,</span><br><span class="line">  &quot;../sw.js&quot;: &quot;/dist/../sw.js&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 我们传入文件名，因为创建一个现代的<code>monifest.json</code>以及一个用于兼容的<code>manifest-legacy.json</code>，它们分别具有现代ES2015+模块和兼容旧版ES5模块的入口点。对于为现代以及旧版本生成的资源，这两个json文件中的关键点都是一致的。</p>
<p> 接下来我们有一个相当标准的<code>configureVueLoader()</code>配置：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> // Configure Vue loader</span><br><span class="line">const configureVueLoader = () =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        test: /\.vue$/,</span><br><span class="line">        loader: &apos;vue-loader&apos;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 这配置只是让我们轻松解析<a href="https://vuejs.org/v2/guide/single-file-components.html" target="_blank" rel="noopener">Vue单文件组件</a>，webpack负责为你提取适当的HTML、CSS和Javascript。</p>
<h2 id="BASE-CONFIG"><a href="#BASE-CONFIG" class="headerlink" title="BASE CONFIG"></a>BASE CONFIG</h2><p> <code>baseConfig</code>将与<code>modernConfig</code>和<code>legacyConfig</code>合并：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> // The base webpack config</span><br><span class="line">const baseConfig = &#123;</span><br><span class="line">    name: pkg.name,</span><br><span class="line">    entry: configureEntries(),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, settings.paths.dist.base),</span><br><span class="line">        publicPath: settings.urls.publicPath</span><br><span class="line">    &#125;,</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        alias: &#123;</span><br><span class="line">            &apos;vue$&apos;: &apos;vue/dist/vue.esm.js&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            configureVueLoader(),</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        new WebpackNotifierPlugin(&#123;title: &apos;Webpack&apos;, excludeWarnings: true, alwaysNotify: true&#125;),</span><br><span class="line">        new VueLoaderPlugin(),</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 这里所有的配置都是非常标准的webpack配置，但请注意我们将<code>vue$</code>指向<code>vue/dist/vue.esm.js</code>，以便我们可以获得Vue的ES2015模块版本。</p>
<p> 我们使用<a href="https://www.npmjs.com/package/webpack-notifier" target="_blank" rel="noopener">WebpackNotifierPlugin</a>插件以直观的方式告诉我们构建的状态。</p>
<h2 id="LEGACY-CONFIG"><a href="#LEGACY-CONFIG" class="headerlink" title="LEGACY CONFIG"></a>LEGACY CONFIG</h2><p> <code>legacyConfig</code>配置用于使用合适的polyfill构建兼容旧版本ES5：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> // Legacy webpack config</span><br><span class="line">const legacyConfig = &#123;</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            configureBabelLoader(Object.values(pkg.browserslist.legacyBrowsers)),</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        new CopyWebpackPlugin(</span><br><span class="line">            settings.copyWebpackConfig</span><br><span class="line">        ),</span><br><span class="line">        new ManifestPlugin(</span><br><span class="line">            configureManifest(&apos;manifest-legacy.json&apos;)</span><br><span class="line">        ),</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 请注意，我们将<code>pkg.browserslist.legacyBrowsers</code>传递给<code>configureBabelLoader()</code>，将<code>manifest-legacy.json</code>传递给<code>configureManifest()</code>。</p>
<p> 我们还在此配置中加入了<code>CopyWebpackPlugin</code>插件，我们只需要复制<code>settings.copyWebpackConfig</code>中定义的文件一次。</p>
<h2 id="MODERN-CONFIG"><a href="#MODERN-CONFIG" class="headerlink" title="MODERN CONFIG"></a>MODERN CONFIG</h2><p> <code>modernConfig</code>用于构建现代ES2015 Javascript模块，不需要借助其他东西：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> // Modern webpack config</span><br><span class="line">const modernConfig = &#123;</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            configureBabelLoader(Object.values(pkg.browserslist.modernBrowsers)),</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        new ManifestPlugin(</span><br><span class="line">            configureManifest(&apos;manifest.json&apos;)</span><br><span class="line">        ),</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 请注意，我们将<code>pkg.browserslist.modernBrowsers</code>传递给<code>configureBabelLoader()</code>，将<code>manifest.json</code>传递给<code>configureManifest()</code>。</p>
<h2 id="MODULE-EXPORTS"><a href="#MODULE-EXPORTS" class="headerlink" title="MODULE.EXPORTS"></a>MODULE.EXPORTS</h2><p> 最后，<code>module.exports</code>使用<code>webpack-merge</code>插件将之前的配置合并在一起，并返回<code>webpack.dev.js</code>和<code>webpack.prod.js</code>使用的对象。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> // Common module exports</span><br><span class="line">// noinspection WebpackConfigHighlighting</span><br><span class="line">module.exports = &#123;</span><br><span class="line">    &apos;legacyConfig&apos;: merge(</span><br><span class="line">        legacyConfig,</span><br><span class="line">        baseConfig,</span><br><span class="line">    ),</span><br><span class="line">    &apos;modernConfig&apos;: merge(</span><br><span class="line">        modernConfig,</span><br><span class="line">        baseConfig,</span><br><span class="line">    ),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="ANNOTATED-WEBPACK-DEV-JS"><a href="#ANNOTATED-WEBPACK-DEV-JS" class="headerlink" title="ANNOTATED WEBPACK.DEV.JS"></a>ANNOTATED WEBPACK.DEV.JS</h2><p> 现在让我们看看<code>webpack.dev.js</code>配置文件，它包含了我们开发项目时用于构建的所有设置，与<code>webpack.common.js</code>文件中的设置合并，形成一个完整的webpack配置。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> // webpack.dev.js - developmental builds</span><br><span class="line">const LEGACY_CONFIG = &apos;legacy&apos;;</span><br><span class="line">const MODERN_CONFIG = &apos;modern&apos;;</span><br><span class="line"></span><br><span class="line">// node modules</span><br><span class="line">const merge = require(&apos;webpack-merge&apos;);</span><br><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const sane = require(&apos;sane&apos;);</span><br><span class="line">const webpack = require(&apos;webpack&apos;);</span><br><span class="line"></span><br><span class="line">// webpack plugins</span><br><span class="line">const Dashboard = require(&apos;webpack-dashboard&apos;);</span><br><span class="line">const DashboardPlugin = require(&apos;webpack-dashboard/plugin&apos;);</span><br><span class="line">const dashboard = new Dashboard();</span><br><span class="line"></span><br><span class="line">// config files</span><br><span class="line">const common = require(&apos;./webpack.common.js&apos;);</span><br><span class="line">const pkg = require(&apos;./package.json&apos;);</span><br><span class="line">const settings = require(&apos;./webpack.settings.js&apos;);</span><br></pre></td></tr></table></figure>
<p> 在序言中，我们再次引入了需要用到的node包，以及使用的webpack插件，然后引入<code>webpack.settings.js</code>作为<code>settings</code>，以便我们可以访问那里的设置，并导入<code>package.json</code>作为<code>pkg</code>，以便访问那里的一些设置。</p>
<p> 我们同时还导入了<code>webpack.common.js</code>常用的webpack配置，并将合并到我们的开发设置。</p>
<h2 id="CONFIGURATION-FUNCTIONS-1"><a href="#CONFIGURATION-FUNCTIONS-1" class="headerlink" title="CONFIGURATION FUNCTIONS"></a>CONFIGURATION FUNCTIONS</h2><p> 这是<code>configureDevServer()</code>的配置：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> // Configure the webpack-dev-server</span><br><span class="line">const configureDevServer = (buildType) =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        public: settings.devServerConfig.public(),</span><br><span class="line">        contentBase: path.resolve(__dirname, settings.paths.templates),</span><br><span class="line">        host: settings.devServerConfig.host(),</span><br><span class="line">        port: settings.devServerConfig.port(),</span><br><span class="line">        https: !!parseInt(settings.devServerConfig.https()),</span><br><span class="line">        quiet: true,</span><br><span class="line">        hot: true,</span><br><span class="line">        hotOnly: true,</span><br><span class="line">        overlay: true,</span><br><span class="line">        stats: &apos;errors-only&apos;,</span><br><span class="line">        watchOptions: &#123;</span><br><span class="line">            poll: !!parseInt(settings.devServerConfig.poll()),</span><br><span class="line">            ignored: /node_modules/,</span><br><span class="line">        &#125;,</span><br><span class="line">        headers: &#123;</span><br><span class="line">            &apos;Access-Control-Allow-Origin&apos;: &apos;*&apos;</span><br><span class="line">        &#125;,</span><br><span class="line">        // Use sane to monitor all of the templates files and sub-directories</span><br><span class="line">        before: (app, server) =&gt; &#123;</span><br><span class="line">            const watcher = sane(path.join(__dirname, settings.paths.templates), &#123;</span><br><span class="line">                glob: [&apos;**/*&apos;],</span><br><span class="line">                poll: !!parseInt(settings.devServerConfig.poll()),</span><br><span class="line">            &#125;);</span><br><span class="line">            watcher.on(&apos;change&apos;, function(filePath, root, stat) &#123;</span><br><span class="line">                console.log(&apos;  File modified:&apos;, filePath);</span><br><span class="line">                server.sockWrite(server.sockets, &quot;content-changed&quot;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 当我们进行生产构建时，webpack绑定所有各种资源并保存到文件系统中，相比之下，当我们在本地项目中开发时，我们通过<a href="http://github.com/webpack/webpack-dev-server" target="_blank" rel="noopener"><code>webpack-dev-server</code></a>使用开发构建：</p>
<ul>
<li><p>启动为我们的资源提供服务的本地<a href="http://expressjs.com/" target="_blank" rel="noopener">express</a> web服务器。</p>
</li>
<li><p>为了提升速度，在内存而不是文件系统中构建我们的资源。</p>
</li>
<li><p>重新构建资源，如JavaScript、css、Vue组件等等，通过使用<a href="https://webpack.js.org/concepts/hot-module-replacement/" target="_blank" rel="noopener">热模块更新（HMR）</a>，当我们修改了这些资源，可以不需要重新加载界面。</p>
</li>
<li><p>在更改模版时将会重新加载页面。</p>
</li>
</ul>
<p>这类似于更复杂的<a href="http://browsersync.io/" target="_blank" rel="noopener">Browsersync</a>变体，大大加快了开发速度。</p>
<p>唯一不同的是我们这里使用了Sane监控不需要通过webpack运行的文件（本例中我们的模板），当该文件修改时，重新加载页面。</p>
<p>注意，<code>webpack-dev-server</code>的配置再次引用了<code>webpack.settings.js</code>文件，对于大部分人来说默认值可能没问题，但我使用<a href="https://laravel.com/docs/5.7/homestead" target="_blank" rel="noopener">Laravel Homestead</a>作为本地开发，像我们在文章<a href="https://nystudio107.com/blog/local-development-with-vagrant-homestead" target="_blank" rel="noopener">Local Development with Vagrant / Homestead</a>讨论的那样，意味着我在Homestead VM中运行所有的开发工具。</p>
<p>因此，<code>webpack.settings.js</code>可以从一个<code>.env</code>文件中读取拥有特定的<code>devServer</code>配置，而不是在我的<code>weboack.settings.js</code>文件中对本地开发环境进行硬编码（因为它可能因人而异）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// .env file DEVSERVER settings</span><br><span class="line"># webpack example settings for Homestead/Vagrant</span><br><span class="line">DEVSERVER_PUBLIC=&quot;http://192.168.10.10:8080&quot;</span><br><span class="line">DEVSERVER_HOST=&quot;0.0.0.0&quot;</span><br><span class="line">DEVSERVER_POLL=1</span><br><span class="line">DEVSERVER_PORT=8080</span><br><span class="line">DEVSERVER_HTTPS=0</span><br></pre></td></tr></table></figure>
<p>你可以使用不同的配置，因此可以根据需要在<code>.env</code>文件中更改设置，<a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="noopener">dotenv</a>背后的想法是我们在<code>.env</code>文件中定义了一个特定于环境的配置，不会将其签入git repo。如果<code>.env</code>文件不存在，那很好，使用默认值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// webpack.settings.js devServerConfig defaults</span><br><span class="line">devServerConfig: &#123;</span><br><span class="line">    public: () =&gt; process.env.DEVSERVER_PUBLIC || &quot;http://localhost:8080&quot;,</span><br><span class="line">    host: () =&gt; process.env.DEVSERVER_HOST || &quot;localhost&quot;,</span><br><span class="line">    poll: () =&gt; process.env.DEVSERVER_POLL || false,</span><br><span class="line">    port: () =&gt; process.env.DEVSERVER_PORT || 8080,</span><br><span class="line">    https: () =&gt; process.env.DEVSERVER_HTTPS || false,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>接下来是<code>configureImageLoader()</code>配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// webpack.dev.js configureImageLoader()</span><br><span class="line">// Configure Image loader</span><br><span class="line">const configureImageLoader = (buildType) =&gt; &#123;</span><br><span class="line">    if (buildType === LEGACY_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(png|jpe?g|gif|svg|webp)$/i,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;file-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        name: &apos;img/[name].[hash].[ext]&apos;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (buildType === MODERN_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(png|jpe?g|gif|svg|webp)$/i,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;file-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        name: &apos;img/[name].[hash].[ext]&apos;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>传入<code>buildType</code>参数，以便返回不同的结果，具体取决于它是旧版本还是新版构建，在该例子中，我们返回了相同的配置，但可以想象可能会改变。</p>
<p>值得注意的是，这只是适用于我们webpack构建中包含的图片；许多其他的图片来自于其他地方（CMS系统，资产管理系统等等）。</p>
<p>要让webpack知道这里有图像，需要将其导入到你的JavaScript文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import Icon from &apos;./icon.png&apos;;</span><br></pre></td></tr></table></figure>
<p>有关这方面的更多详细信息，请查看webpack文档“<a href="https://webpack.js.org/guides/asset-management/#loading-images" target="_blank" rel="noopener">加载图像</a>”部分。</p>
<p>接下来是<code>configurePostcssLoader()</code>配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// Configure the Postcss loader</span><br><span class="line">const configurePostcssLoader = (buildType) =&gt; &#123;</span><br><span class="line">    // Don&apos;t generate CSS for the legacy config in development</span><br><span class="line">    if (buildType === LEGACY_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(pcss|css)$/,</span><br><span class="line">            loader: &apos;ignore-loader&apos;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (buildType === MODERN_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(pcss|css)$/,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;style-loader&apos;,</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;vue-style-loader&apos;,</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;css-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        importLoaders: 2,</span><br><span class="line">                        sourceMap: true</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;resolve-url-loader&apos;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;postcss-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        sourceMap: true</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们使用<a href="http://postcss.org" target="_blank" rel="noopener">PostCSS</a>来处理所有的css，包括<a href="https://tailwindcss.com/docs/what-is-tailwind/" target="_blank" rel="noopener">Tailwind CSS</a>。我觉得PostCSS是css的Babel，它将各种高级css功能编程成浏览器可以解析的普通css。</p>
<p>对于webpack加载器，它们的处理顺序与列出顺序相反：</p>
<ul>
<li><p><a href="http://github.com/postcss/postcss-loader" target="_blank" rel="noopener">postcss-loader</a> —— 将文件加载并处理为PostCSS</p>
</li>
<li><p><a href="https://www.npmjs.com/package/resolve-url-loader" target="_blank" rel="noopener">resolve-url-loader</a> —— 将css中的所有<code>url()</code>重写为相对路径</p>
</li>
<li><p><a href="https://github.com/webpack-contrib/css-loader" target="_blank" rel="noopener">css-loader</a> —— 解析我们所有的CSS <code>@import</code> 和 <code>url()</code></p>
</li>
<li><p><a href="https://github.com/vuejs/vue-style-loader" target="_blank" rel="noopener">vue-style-loader</a> —— 将.vue 单文件中注入所有的css。</p>
</li>
<li><p><a href="https://github.com/webpack-contrib/style-loader" target="_blank" rel="noopener">style-loader</a> —— 将所有CSS注入到<style></style>中</p>
</li>
</ul>
<p>我们在本地开发过程中不需要将所有css文件提取到最小的文件中，相反我们只是让<code>style-loader</code>在我们的文档中内联它。</p>
<p><code>webpack-dev-server</code>为css使用热模块替换（HMR），每当我们修改样式时，它都会重新构建css并自动注入，很神奇（what）。</p>
<p>我们通过引入它来告知webpack去解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import styles from &apos;../css/app.pcss&apos;;</span><br></pre></td></tr></table></figure>
<p>在webpack文档的<a href="https://webpack.js.org/guides/asset-management/#loading-css" target="_blank" rel="noopener">Loading CSS</a>部分中有详细讨论。</p>
<p>我们从<code>App.js</code>入口点执行此操作，将此视为PostCSS的入口点，<code>app.pcss</code>文件<code>@import</code>我们项目中使用到的所有CSS，后面会对此进行详细介绍。</p>
<h2 id="MODULE-EXPORTS-1"><a href="#MODULE-EXPORTS-1" class="headerlink" title="MODULE.EXPORTS"></a>MODULE.EXPORTS</h2><p>最后，<code>module.exports</code>使用<code>webpack-merge</code>包将<code>webpack.common.js</code>中的<code>common.legacyConfig</code>与我们的开发旧版兼容配置合并，并将<code>common.modernConfig</code>与开发环境现代配置合并：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// Development module exports</span><br><span class="line">module.exports = [</span><br><span class="line">    merge(</span><br><span class="line">        common.legacyConfig,</span><br><span class="line">        &#123;</span><br><span class="line">            output: &#123;</span><br><span class="line">                filename: path.join(&apos;./js&apos;, &apos;[name]-legacy.[hash].js&apos;),</span><br><span class="line">                publicPath: settings.devServerConfig.public() + &apos;/&apos;,</span><br><span class="line">            &#125;,</span><br><span class="line">            mode: &apos;development&apos;,</span><br><span class="line">            devtool: &apos;inline-source-map&apos;,</span><br><span class="line">            devServer: configureDevServer(LEGACY_CONFIG),</span><br><span class="line">            module: &#123;</span><br><span class="line">                rules: [</span><br><span class="line">                    configurePostcssLoader(LEGACY_CONFIG),</span><br><span class="line">                    configureImageLoader(LEGACY_CONFIG),</span><br><span class="line">                ],</span><br><span class="line">            &#125;,</span><br><span class="line">            plugins: [</span><br><span class="line">                new webpack.HotModuleReplacementPlugin(),</span><br><span class="line">            ],</span><br><span class="line">        &#125;</span><br><span class="line">    ),</span><br><span class="line">    merge(</span><br><span class="line">        common.modernConfig,</span><br><span class="line">        &#123;</span><br><span class="line">            output: &#123;</span><br><span class="line">                filename: path.join(&apos;./js&apos;, &apos;[name].[hash].js&apos;),</span><br><span class="line">                publicPath: settings.devServerConfig.public() + &apos;/&apos;,</span><br><span class="line">            &#125;,</span><br><span class="line">            mode: &apos;development&apos;,</span><br><span class="line">            devtool: &apos;inline-source-map&apos;,</span><br><span class="line">            devServer: configureDevServer(MODERN_CONFIG),</span><br><span class="line">            module: &#123;</span><br><span class="line">                rules: [</span><br><span class="line">                    configurePostcssLoader(MODERN_CONFIG),</span><br><span class="line">                    configureImageLoader(MODERN_CONFIG),</span><br><span class="line">                ],</span><br><span class="line">            &#125;,</span><br><span class="line">            plugins: [</span><br><span class="line">                new webpack.HotModuleReplacementPlugin(),</span><br><span class="line">                new DashboardPlugin(dashboard.setData),</span><br><span class="line">            ],</span><br><span class="line">        &#125;</span><br><span class="line">    ),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>通过<code>module.exports</code>中返回一个数组，我们告知webpack有多个需要执行的编译：一个用于旧版兼容构建，另一个用于新版构建。</p>
<p>对于旧版构建，我们将处理后的JavaScript命名为<code>[name]-legacy.[hash].js</code>，而新版构建命名为<code>[name].[hash].js</code>。</p>
<p>通过设置<code>mode</code>为<code>development</code>，告知webpack这是开发环境构建。</p>
<p>将<a href="https://webpack.js.org/configuration/devtool/" target="_blank" rel="noopener"><code>devtool</code></a>设置为<code>inline-source-map</code>，我们要求将CSS/JavsScript的<code>.map</code>内联到文件中，虽然构建出来的项目会偏大，但是便于开发调试。</p>
<p>通过<a href="https://webpack.js.org/plugins/hot-module-replacement-plugin/" target="_blank" rel="noopener">webpack.HotModuleReplacementPlugin</a>插件，可以支持Webpack的热模块替换（HMR）。</p>
<p><a href="http://github.com/FormidableLabs/webpack-dashboard" target="_blank" rel="noopener">DashboardPlugin</a>插件让我们觉得自己是一个宇航员，拥有一个酷炫的面板：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/5/16779f3aca8f50ac?w=1200&amp;h=699&amp;f=png&amp;s=262901" alt=""></p>
<p>我发现<code>DashboardPlugin</code>插件开发<code>HUD</code>比默认的webpack进度展示更直观。</p>
<p>到这里，现在已经为我们项目提供了一个很好的开发环境配置，查看热模块替换视频，了解该操作的<a href="https://youtu.be/9-n2Ah0aowo" target="_blank" rel="noopener">示例</a>。</p>
<iframe width="576" height="324" src="https://www.youtube.com/embed/9-n2Ah0aowo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h2 id="ANNOTATED-WEBPACK-PROD-JS"><a href="#ANNOTATED-WEBPACK-PROD-JS" class="headerlink" title="ANNOTATED WEBPACK.PROD.JS"></a>ANNOTATED WEBPACK.PROD.JS</h2><p>现在我们看看<code>webpack.prod.js</code>配置文件，它包含我们正在处理项目时用于生产构建的所有配置。它与<code>webpack.common.js</code>中的设置合并，形成一个完整的webpack配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// webpack.prod.js - production builds</span><br><span class="line">const LEGACY_CONFIG = &apos;legacy&apos;;</span><br><span class="line">const MODERN_CONFIG = &apos;modern&apos;;</span><br><span class="line"></span><br><span class="line">// node modules</span><br><span class="line">const git = require(&apos;git-rev-sync&apos;);</span><br><span class="line">const glob = require(&apos;glob-all&apos;);</span><br><span class="line">const merge = require(&apos;webpack-merge&apos;);</span><br><span class="line">const moment = require(&apos;moment&apos;);</span><br><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const webpack = require(&apos;webpack&apos;);</span><br><span class="line"></span><br><span class="line">// webpack plugins</span><br><span class="line">const BundleAnalyzerPlugin = require(&apos;webpack-bundle-analyzer&apos;).BundleAnalyzerPlugin;</span><br><span class="line">const CleanWebpackPlugin = require(&apos;clean-webpack-plugin&apos;);</span><br><span class="line">const CreateSymlinkPlugin = require(&apos;create-symlink-webpack-plugin&apos;);</span><br><span class="line">const CriticalCssPlugin = require(&apos;critical-css-webpack-plugin&apos;);</span><br><span class="line">const HtmlWebpackPlugin = require(&apos;html-webpack-plugin&apos;);</span><br><span class="line">const ImageminWebpWebpackPlugin = require(&apos;imagemin-webp-webpack-plugin&apos;);</span><br><span class="line">const MiniCssExtractPlugin = require(&apos;mini-css-extract-plugin&apos;);</span><br><span class="line">const OptimizeCSSAssetsPlugin = require(&apos;optimize-css-assets-webpack-plugin&apos;);</span><br><span class="line">const PurgecssPlugin = require(&apos;purgecss-webpack-plugin&apos;);</span><br><span class="line">const SaveRemoteFilePlugin = require(&apos;save-remote-file-webpack-plugin&apos;);</span><br><span class="line">const TerserPlugin = require(&apos;terser-webpack-plugin&apos;);</span><br><span class="line">const WebappWebpackPlugin = require(&apos;webapp-webpack-plugin&apos;);</span><br><span class="line">const WhitelisterPlugin = require(&apos;purgecss-whitelister&apos;);</span><br><span class="line">const WorkboxPlugin = require(&apos;workbox-webpack-plugin&apos;);</span><br><span class="line"></span><br><span class="line">// config files</span><br><span class="line">const common = require(&apos;./webpack.common.js&apos;);</span><br><span class="line">const pkg = require(&apos;./package.json&apos;);</span><br><span class="line">const settings = require(&apos;./webpack.settings.js&apos;);</span><br></pre></td></tr></table></figure>
<p>我们再次引入了在序言中涉及到的node包，以及我们使用的webpack插件，然后将<code>webpack.settings.js</code>作为<code>settings</code>导入，并将<code>package.json</code>作为<code>pkg</code>导入，便于访问需要用到的配置。</p>
<p>我们还导入了<code>webpack.common.js</code>中公共的webpack配置，我们将与开发设置合并。</p>
<h2 id="TAILWIND-EXTRACTOR"><a href="#TAILWIND-EXTRACTOR" class="headerlink" title="TAILWIND EXTRACTOR"></a>TAILWIND EXTRACTOR</h2><p>该类是<a href="http://tailwindcss.com/docs/what-is-tailwind/" target="_blank" rel="noopener">Tailwind CSS</a>的自定义<a href="http://www.purgecss.com/" target="_blank" rel="noopener">PurgeCSS</a>提取器，允许在类名中使用特殊字符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Custom PurgeCSS extractor for Tailwind that allows special characters in</span><br><span class="line">// class names.</span><br><span class="line">//</span><br><span class="line">// https://github.com/FullHuman/purgecss#extractor</span><br><span class="line">class TailwindExtractor &#123;</span><br><span class="line">    static extract(content) &#123;</span><br><span class="line">        return content.match(/[A-Za-z0-9-_:\/]+/g) || [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这取自Tailwind CSS文档中<a href="http://tailwindcss.com/docs/controlling-file-size/#removing-unused-css-with-purgecss" target="_blank" rel="noopener">Removing unused CSS with PurgeCSS</a>这一部分。有关此提取器如何与 purgcss 配合使用的详细信息, 请参阅下文, 让你的css变得更加的整洁。</p>
<h2 id="CONFIGURATION-FUNCTIONS-2"><a href="#CONFIGURATION-FUNCTIONS-2" class="headerlink" title="CONFIGURATION FUNCTIONS"></a>CONFIGURATION FUNCTIONS</h2><p>这是<code>configureBanner()</code>函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// Configure file banner</span><br><span class="line">const configureBanner = () =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        banner: [</span><br><span class="line">            &apos;/*!&apos;,</span><br><span class="line">            &apos; * @project        &apos; + settings.name,</span><br><span class="line">            &apos; * @name           &apos; + &apos;[filebase]&apos;,</span><br><span class="line">            &apos; * @author         &apos; + pkg.author.name,</span><br><span class="line">            &apos; * @build          &apos; + moment().format(&apos;llll&apos;) + &apos; ET&apos;,</span><br><span class="line">            &apos; * @release        &apos; + git.long() + &apos; [&apos; + git.branch() + &apos;]&apos;,</span><br><span class="line">            &apos; * @copyright      Copyright (c) &apos; + moment().format(&apos;YYYY&apos;) + &apos; &apos; + settings.copyright,</span><br><span class="line">            &apos; *&apos;,</span><br><span class="line">            &apos; */&apos;,</span><br><span class="line">            &apos;&apos;</span><br><span class="line">        ].join(&apos;\n&apos;),</span><br><span class="line">        raw: true</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这只是为我们生成的每个文件添加了一个带有项目名称、文件名、作者和 git 信息的banner。</p>
<p>接着是<code>configureBundleAnalyzer()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// webpack.prod.js configureBundleAnalyzer()</span><br><span class="line">// Configure Bundle Analyzer</span><br><span class="line">const configureBundleAnalyzer = (buildType) =&gt; &#123;</span><br><span class="line">    if (buildType === LEGACY_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            analyzerMode: &apos;static&apos;,</span><br><span class="line">            reportFilename: &apos;report-legacy.html&apos;,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (buildType === MODERN_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            analyzerMode: &apos;static&apos;,</span><br><span class="line">            reportFilename: &apos;report-modern.html&apos;,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>使用 <a href="https://www.npmjs.com/package/webpack-bundle-analyzer" target="_blank" rel="noopener">WebpackBundleAnalyzer</a> 插件为我们的新版和旧版本构建生成一份报告，并且生成一个独立可交互的HTML页面，可以查看webpack打包后的确切内容。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/5/1677f14f05c3db38?w=1200&amp;h=675&amp;f=png&amp;s=865987" alt=""></p>
<p>我发现这个插件挺有用，可以帮助我缩小最终构建包的大小，而且确切地了解了webpack构建了什么，所以我已经把它作为项目生产构建过程的一部分。</p>
<p>接着是<code>configureCriticalCss()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// webpack.prod.js configureCriticalCss()</span><br><span class="line">// Configure Critical CSS</span><br><span class="line">const configureCriticalCss = () =&gt; &#123;</span><br><span class="line">    return (settings.criticalCssConfig.pages.map((row) =&gt; &#123;</span><br><span class="line">            const criticalSrc = settings.urls.critical + row.url;</span><br><span class="line">            const criticalDest = settings.criticalCssConfig.base + row.template + settings.criticalCssConfig.suffix;</span><br><span class="line">            let criticalWidth = settings.criticalCssConfig.criticalWidth;</span><br><span class="line">            let criticalHeight = settings.criticalCssConfig.criticalHeight;</span><br><span class="line">            // Handle Google AMP templates</span><br><span class="line">            if (row.template.indexOf(settings.criticalCssConfig.ampPrefix) !== -1) &#123;</span><br><span class="line">                criticalWidth = settings.criticalCssConfig.ampCriticalWidth;</span><br><span class="line">                criticalHeight = settings.criticalCssConfig.ampCriticalHeight;</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;source: &quot; + criticalSrc + &quot; dest: &quot; + criticalDest);</span><br><span class="line">            return new CriticalCssPlugin(&#123;</span><br><span class="line">                base: &apos;./&apos;,</span><br><span class="line">                src: criticalSrc,</span><br><span class="line">                dest: criticalDest,</span><br><span class="line">                extract: false,</span><br><span class="line">                inline: false,</span><br><span class="line">                minify: true,</span><br><span class="line">                width: criticalWidth,</span><br><span class="line">                height: criticalHeight,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>使用<a href="https://www.npmjs.com/package/critical-css-webpack-plugin" target="_blank" rel="noopener"><code>CriticalCssPlugin</code></a>插件通过<code>webpack.settings.js</code>中的<code>settings.criticalCssConfig.pages</code>进行分块，为我们的网站生成CriticalCSS。</p>
<p>需要注意的是，如果传入的页面在任何位置的名字都包含<code>settings.criticalCssConfig.ampPrefix</code>，则它将通过传入非常大的高度为整个网页（而不仅仅是上面的折叠内容）生成CriticalCSS。</p>
<p>这里不会详细介绍CriticalCSS，有关它的更多资料，请查看<a href="https://nystudio107.com/blog/implementing-critical-css" target="_blank" rel="noopener">Implementing Critical CSS on your website</a>这篇文章。</p>
<p>接着是<code>configureCleanWebpack()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Configure Clean webpack</span><br><span class="line">const configureCleanWebpack = () =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        root: path.resolve(__dirname, settings.paths.dist.base),</span><br><span class="line">        verbose: true,</span><br><span class="line">        dry: false</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这只是使用<a href="https://github.com/johnagan/clean-webpack-plugin" target="_blank" rel="noopener">CleanWebpackPlugin</a>从我们的<code>webpack.settings.js</code>中删除 <code>settings.paths.dist.base</code> 中的生成目录。</p>
<p>接着是<code>configureHtml()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Configure Html webpack</span><br><span class="line">const configureHtml = () =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        templateContent: &apos;&apos;,</span><br><span class="line">        filename: &apos;webapp.html&apos;,</span><br><span class="line">        inject: false,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这将使用<a href="https://webpack.js.org/plugins/html-webpack-plugin/" target="_blank" rel="noopener">HtmlWebpackPlugin</a>与<a href="http://github.com/brunocodutra/webapp-webpack-plugin" target="_blank" rel="noopener">WebappWebpackPlugin</a>（见下文）插件为我们的favicons生成HTML。注意，我们在<code>templateContent</code>中传入一个空字符串，以便输出只是WebappWebpackPlugin的原始输出。</p>
<p>接着是<code>configureImageLoader()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// Configure Image loader</span><br><span class="line">const configureImageLoader = (buildType) =&gt; &#123;</span><br><span class="line">    if (buildType === LEGACY_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(png|jpe?g|gif|svg|webp)$/i,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;file-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        name: &apos;img/[name].[hash].[ext]&apos;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (buildType === MODERN_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(png|jpe?g|gif|svg|webp)$/i,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;file-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        name: &apos;img/[name].[hash].[ext]&apos;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;img-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        plugins: [</span><br><span class="line">                            require(&apos;imagemin-gifsicle&apos;)(&#123;</span><br><span class="line">                                interlaced: true,</span><br><span class="line">                            &#125;),</span><br><span class="line">                            require(&apos;imagemin-mozjpeg&apos;)(&#123;</span><br><span class="line">                                progressive: true,</span><br><span class="line">                                arithmetic: false,</span><br><span class="line">                            &#125;),</span><br><span class="line">                            require(&apos;imagemin-optipng&apos;)(&#123;</span><br><span class="line">                                optimizationLevel: 5,</span><br><span class="line">                            &#125;),</span><br><span class="line">                            require(&apos;imagemin-svgo&apos;)(&#123;</span><br><span class="line">                                plugins: [</span><br><span class="line">                                    &#123;convertPathData: false&#125;,</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;),</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们传入<code>buildType</code>参数，以至于我们可以返回不同的结果，具体取决于它是新版还是旧版构建。我们通过优化处理图像，通过<a href="http://www.npmjs.com/package/img-loader" target="_blank" rel="noopener">img-loader</a>进行新版构建。</p>
<p>我们只对新版构建执行此操作，因为花费时间去处理优化新版本和旧版本的图像没有意义（图像对于两者都是一样的）。</p>
<p>需要注意的是，这只适用于我们的webpack构建中包含的图像，许多其他图像资源其实来自来与其他地方（cms 系统、资产管理系统等）。</p>
<p>要让webpack优化图像，请将其导入 JavaScript：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import Icon from &apos;./icon.png&apos;;</span><br></pre></td></tr></table></figure>
<p>更多<a href="https://webpack.js.org/guides/asset-management/#loading-images" target="_blank" rel="noopener">Loading Images</a>详细信息，请查看webpack文档对应部分。</p>
<p>接着是我们的<code>configureOptimization()</code>配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// Configure optimization</span><br><span class="line">const configureOptimization = (buildType) =&gt; &#123;</span><br><span class="line">    if (buildType === LEGACY_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            splitChunks: &#123;</span><br><span class="line">                cacheGroups: &#123;</span><br><span class="line">                    default: false,</span><br><span class="line">                    common: false,</span><br><span class="line">                    styles: &#123;</span><br><span class="line">                        name: settings.vars.cssName,</span><br><span class="line">                        test: /\.(pcss|css|vue)$/,</span><br><span class="line">                        chunks: &apos;all&apos;,</span><br><span class="line">                        enforce: true</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            minimizer: [</span><br><span class="line">                new TerserPlugin(</span><br><span class="line">                    configureTerser()</span><br><span class="line">                ),</span><br><span class="line">                new OptimizeCSSAssetsPlugin(&#123;</span><br><span class="line">                    cssProcessorOptions: &#123;</span><br><span class="line">                        map: &#123;</span><br><span class="line">                            inline: false,</span><br><span class="line">                            annotation: true,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        safe: true,</span><br><span class="line">                        discardComments: true</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;)</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (buildType === MODERN_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            minimizer: [</span><br><span class="line">                new TerserPlugin(</span><br><span class="line">                    configureTerser()</span><br><span class="line">                ),</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这是<a href="https://webpack.js.org/configuration/optimization/" target="_blank" rel="noopener">webpack生产环境优化</a>的配置，对于旧版构建（执行此操作两次没有任何意义），我们使用<a href="http://github.com/webpack-contrib/mini-css-extract-plugin" target="_blank" rel="noopener"><code>MiniCssExtractPlugin</code></a>插件将项目里使用到的css提取到单个css文件中。如果您以前使用过webpack，那么以前应该已经使用过ExtractTextPlugin来执行过此操作，然而现在不需要这么做了。</p>
<p>我们还使用了<a href="http://github.com/NMFR/optimize-css-assets-webpack-plugin" target="_blank" rel="noopener"><code>OptimizeCSSAssetsPlugin</code></a>插件通过删除重复的规则来优化生成的css，并通过<code>cssnano</code>压缩css。</p>
<p>最后，我们将Javascript <code>minimizer</code>设置成<a href="http://github.com/webpack-contrib/terser-webpack-plugin" target="_blank" rel="noopener">TerserPlugin</a>，这是因为[UglifyJsPlugin]<br>(<a href="http://github.com/webpack-contrib/uglifyjs-webpack-plugin/releases/tag/v2.0.0)不再支持最小化ES2015+JavaScript。由于我们正在生成新版es2015+bundles,我们需要它。" target="_blank" rel="noopener">http://github.com/webpack-contrib/uglifyjs-webpack-plugin/releases/tag/v2.0.0)不再支持最小化ES2015+JavaScript。由于我们正在生成新版es2015+bundles,我们需要它。</a></p>
<p>接着是<code>configurePostcssLoader()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// Configure Postcss loader</span><br><span class="line">const configurePostcssLoader = (buildType) =&gt; &#123;</span><br><span class="line">    if (buildType === LEGACY_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(pcss|css)$/,</span><br><span class="line">            use: [</span><br><span class="line">                MiniCssExtractPlugin.loader,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;css-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        importLoaders: 2,</span><br><span class="line">                        sourceMap: true</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;resolve-url-loader&apos;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &apos;postcss-loader&apos;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        sourceMap: true</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    // Don&apos;t generate CSS for the modern config in production</span><br><span class="line">    if (buildType === MODERN_CONFIG) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            test: /\.(pcss|css)$/,</span><br><span class="line">            loader: &apos;ignore-loader&apos;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个配置看起来十分类似于开发版本的<code>configurePostcssLoader()</code>，除了最终加载器，我们使用<a href="http://github.com/webpack-contrib/mini-css-extract-plugin" target="_blank" rel="noopener">MiniCssExtractPlugin.loader</a>将所有css提取到一个文件中。</p>
<p>我们只对旧版兼容构建执行此操作，因为对每个构建执行它没有意义（css是相同的）。我们使用<a href="http://www.npmjs.com/package/ignore-loader" target="_blank" rel="noopener">ignore-loader</a>进行新版构建，因此我们的.css和.pcss文件存在一个加载器，但什么都没做。</p>
<p>如前面说到，我们使用<a href="https://postcss.org/" target="_blank" rel="noopener">PostCSS</a>处理所有的css，包括<a href="http://tailwindcss.com/docs/what-is-tailwind/" target="_blank" rel="noopener">Tailwind CSS</a>，我认为它是CSS的babel，因为它将各种高级的css功能编译成你的浏览器可以解析的普通css。</p>
<p>同样，对于webpack加载器，它们按照列出的相反顺序进行处理：</p>
<ul>
<li><p><a href="http://github.com/postcss/postcss-loader" target="_blank" rel="noopener">postcss-loader</a> —— 将文件加载并处理为 PostCSS</p>
</li>
<li><p><a href="https://www.npmjs.com/package/resolve-url-loader" target="_blank" rel="noopener">resolve-url-loader</a> —— 将css中的所有url()重写为相对路径</p>
</li>
<li><p><a href="https://github.com/webpack-contrib/css-loader" target="_blank" rel="noopener">css-loader</a> —— 解析我们所有的CSS @import 和 url()</p>
</li>
<li><p><a href="http://github.com/webpack-contrib/mini-css-extract-plugin" target="_blank" rel="noopener">MiniCssExtractPlugin.loader</a> —— 将所有css提取到一个文件中</p>
</li>
</ul>
<p>由于这是一个生产环境构建，我们使用<code>MiniCssExtractPlugin.loader</code>提取所有使用到的css，并保存到<code>.css</code>文件中。CSS也被最小化，并针对生产环境进行了优化。</p>
<p>我们通过引入css文件告知webpack：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import styles from &apos;../css/app.pcss&apos;;</span><br></pre></td></tr></table></figure>
<p>这在webpack文档的<a href="https://webpack.js.org/guides/asset-management/#loading-css" target="_blank" rel="noopener">Loading CSS</a>有详细介绍。</p>
<p>我们从App.js入口点执行此操作，将此视为postCSS的入口点，<code>app.pcss</code>文件<code>@import</code>我们项目使用的所有CSS，稍后将详细介绍。</p>
<p>接着是<code>configurePurgeCss()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Configure PurgeCSS</span><br><span class="line">const configurePurgeCss = () =&gt; &#123;</span><br><span class="line">    let paths = [];</span><br><span class="line">    // Configure whitelist paths</span><br><span class="line">    for (const [key, value] of Object.entries(settings.purgeCssConfig.paths)) &#123;</span><br><span class="line">        paths.push(path.join(__dirname, value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">        paths: glob.sync(paths),</span><br><span class="line">        whitelist: WhitelisterPlugin(settings.purgeCssConfig.whitelist),</span><br><span class="line">        whitelistPatterns: settings.purgeCssConfig.whitelistPatterns,</span><br><span class="line">        extractors: [</span><br><span class="line">            &#123;</span><br><span class="line">                extractor: TailwindExtractor,</span><br><span class="line">                extensions: settings.purgeCssConfig.extensions</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a href="http://tailwindcss.com/docs/what-is-tailwind/" target="_blank" rel="noopener">Tailwind CSS</a>是一个出色的实用程序优先的CSS框架，它允许快速原型化，因为在本地开发中，很少需要实际编写任何css。 相反，你只需要使用提供的实用程序CSS类。</p>
<p>缺点就是生成的CSS可能有点大，这时候就需要用到<a href="http://www.purgecss.com/" target="_blank" rel="noopener">PurgeCSS</a>，它将解析所有HTML/template/Vue/任何文件，并删除没有使用到的CSS。</p>
<p>节省的空间可能很大，Tailwind CSS和PurgeCSS是天作之合。我们在<a href="http://devmode.fm/episodes/tailwind-css-utility-first-css-with-adam-watham" target="_blank" rel="noopener"> Tailwind CSS utility-first CSS with Adam Wathan</a>博客中深入讨论了这个问题。</p>
<p>它遍历<code>settings.purgeCssConfig.paths</code>中的所有路径<code>globs</code>，以寻找要保留的CSS规则，任何未找到的CSS规则都会从我们生成的CSS构建中删除。</p>
<p>我们还使用了<a href="https://www.npmjs.com/package/purgecss-whitelister" target="_blank" rel="noopener">WhitelisterPlugin</a>，当我们知道不希望某些CSS<br>被剥离时，可以轻松地将整个文件或全局列入白名单。与我们的<code>settings.purgeCssConfig.whitelist</code>匹配的所有文件中的CSS规则都列入白名单，并且永远不会从生成的构建中删除。</p>
<p>接下来是<code>configureTerser()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Configure terser</span><br><span class="line">const configureTerser = () =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        cache: true,</span><br><span class="line">        parallel: true,</span><br><span class="line">        sourceMap: true</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这只是配置了[TerserPlugin]<br>(<a href="http://github.com/webpack-contrib/terser-webpack-plugin)使用的一些设置，最大限度地减少了我们的旧版和新版JavaScript代码。" target="_blank" rel="noopener">http://github.com/webpack-contrib/terser-webpack-plugin)使用的一些设置，最大限度地减少了我们的旧版和新版JavaScript代码。</a></p>
<p>接着是<code>configureWebApp()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// Configure Webapp webpack</span><br><span class="line">const configureWebapp = () =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        logo: settings.webappConfig.logo,</span><br><span class="line">        prefix: settings.webappConfig.prefix,</span><br><span class="line">        cache: false,</span><br><span class="line">        inject: &apos;force&apos;,</span><br><span class="line">        favicons: &#123;</span><br><span class="line">            appName: pkg.name,</span><br><span class="line">            appDescription: pkg.description,</span><br><span class="line">            developerName: pkg.author.name,</span><br><span class="line">            developerURL: pkg.author.url,</span><br><span class="line">            path: settings.paths.dist.base,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里使用<a href="http://www.npmjs.com/package/webapp-webpack-plugin" target="_blank" rel="noopener">webappwebpackepulin</a>以无数种格式生成我们所有的网站favicon，以及我们的webapp <code>manifest.json</code>和其他PWA细节。</p>
<p>它与<code>HtmlWebpackPlugin</code>结合使用，还可以输出一个<code>webapp.html</code>文件，它包含所有生成的favicons和相关文件的链接，以包含在我们的HTML页面的<code>&lt;head&gt;&lt;/head&gt;</code>中。</p>
<p>接着是<code>configureWorkbox()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Configure Workbox service worker</span><br><span class="line">const configureWorkbox = () =&gt; &#123;</span><br><span class="line">    let config = settings.workboxConfig;</span><br><span class="line"></span><br><span class="line">    return config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们使用Google的<a href="http://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin" target="_blank" rel="noopener">WorkboxWebpackPlugin</a>为网站生成一个<a href="http://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener">Service Worker</a>，解释 <code>Service Worker</code>是什么超出了本文的内容范围，但可以查看<a href="http://devmode.fm/episodes/going-offline-service-workers-with-jeremy-keith" target="_blank" rel="noopener">Going Offline: Service Workers with Jeremy Keith</a>博客作为入门。</p>
<p>配置数据全部来自<code>webpack.settings.js</code>中的<code>settings.workboxConfig</code>对象。除了预先缓存新版构建<code>minifest.json</code>中所有的资源外，我们还包括一个<code>workbox-catch-handler.js</code>来配置它以使<a href="http://developers.google.com/web/tools/workbox/guides/advanced-recipes#provide_a_fallback_response_to_a_route" target="_blank" rel="noopener">用回退响应catch-all路由</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// fallback URLs</span><br><span class="line">const FALLBACK_HTML_URL = &apos;/offline.html&apos;;</span><br><span class="line">const FALLBACK_IMAGE_URL = &apos;/offline.svg&apos;;</span><br><span class="line"></span><br><span class="line">// This &quot;catch&quot; handler is triggered when any of the other routes fail to</span><br><span class="line">// generate a response.</span><br><span class="line">// https://developers.google.com/web/tools/workbox/guides/advanced-recipes#provide_a_fallback_response_to_a_route</span><br><span class="line">workbox.routing.setCatchHandler((&#123;event, request, url&#125;) =&gt; &#123;</span><br><span class="line">    // Use event, request, and url to figure out how to respond.</span><br><span class="line">    // One approach would be to use request.destination, see</span><br><span class="line">    // https://medium.com/dev-channel/service-worker-caching-strategies-based-on-request-types-57411dd7652c</span><br><span class="line">    switch (request.destination) &#123;</span><br><span class="line">        case &apos;document&apos;:</span><br><span class="line">            return caches.match(FALLBACK_HTML_URL);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case &apos;image&apos;:</span><br><span class="line">            return caches.match(FALLBACK_IMAGE_URL);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            // If we don&apos;t have a fallback, just return an error response.</span><br><span class="line">            return Response.error();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// Use a stale-while-revalidate strategy for all other requests.</span><br><span class="line">workbox.routing.setDefaultHandler(</span><br><span class="line">    workbox.strategies.staleWhileRevalidate()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="MODULE-EXPORTS-2"><a href="#MODULE-EXPORTS-2" class="headerlink" title="MODULE.EXPORTS"></a>MODULE.EXPORTS</h2><p>最后，<code>module.export</code>使用<code>webpack-merge</code>将<code>webpack.commons.js</code>中的<code>common.legacyConfig</code>与我们的生产环境旧版配置合并，并将<code>common.modernConfig</code>与我们的生产环境新版配置合并：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">// Production module exports</span><br><span class="line">module.exports = [</span><br><span class="line">    merge(</span><br><span class="line">        common.legacyConfig,</span><br><span class="line">        &#123;</span><br><span class="line">            output: &#123;</span><br><span class="line">                filename: path.join(&apos;./js&apos;, &apos;[name]-legacy.[chunkhash].js&apos;),</span><br><span class="line">            &#125;,</span><br><span class="line">            mode: &apos;production&apos;,</span><br><span class="line">            devtool: &apos;source-map&apos;,</span><br><span class="line">            optimization: configureOptimization(LEGACY_CONFIG),</span><br><span class="line">            module: &#123;</span><br><span class="line">                rules: [</span><br><span class="line">                    configurePostcssLoader(LEGACY_CONFIG),</span><br><span class="line">                    configureImageLoader(LEGACY_CONFIG),</span><br><span class="line">                ],</span><br><span class="line">            &#125;,</span><br><span class="line">            plugins: [</span><br><span class="line">                new CleanWebpackPlugin(settings.paths.dist.clean,</span><br><span class="line">                    configureCleanWebpack()</span><br><span class="line">                ),</span><br><span class="line">                new MiniCssExtractPlugin(&#123;</span><br><span class="line">                    path: path.resolve(__dirname, settings.paths.dist.base),</span><br><span class="line">                    filename: path.join(&apos;./css&apos;, &apos;[name].[chunkhash].css&apos;),</span><br><span class="line">                &#125;),</span><br><span class="line">                new PurgecssPlugin(</span><br><span class="line">                    configurePurgeCss()</span><br><span class="line">                ),</span><br><span class="line">                new webpack.BannerPlugin(</span><br><span class="line">                    configureBanner()</span><br><span class="line">                ),</span><br><span class="line">                new HtmlWebpackPlugin(</span><br><span class="line">                    configureHtml()</span><br><span class="line">                ),</span><br><span class="line">                new WebappWebpackPlugin(</span><br><span class="line">                    configureWebapp()</span><br><span class="line">                ),</span><br><span class="line">                new CreateSymlinkPlugin(</span><br><span class="line">                    settings.createSymlinkConfig,</span><br><span class="line">                    true</span><br><span class="line">                ),</span><br><span class="line">                new SaveRemoteFilePlugin(</span><br><span class="line">                    settings.saveRemoteFileConfig</span><br><span class="line">                ),</span><br><span class="line">                new BundleAnalyzerPlugin(</span><br><span class="line">                    configureBundleAnalyzer(LEGACY_CONFIG),</span><br><span class="line">                ),</span><br><span class="line">            ].concat(</span><br><span class="line">                configureCriticalCss()</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    ),</span><br><span class="line">    merge(</span><br><span class="line">        common.modernConfig,</span><br><span class="line">        &#123;</span><br><span class="line">            output: &#123;</span><br><span class="line">                filename: path.join(&apos;./js&apos;, &apos;[name].[chunkhash].js&apos;),</span><br><span class="line">            &#125;,</span><br><span class="line">            mode: &apos;production&apos;,</span><br><span class="line">            devtool: &apos;source-map&apos;,</span><br><span class="line">            optimization: configureOptimization(MODERN_CONFIG),</span><br><span class="line">            module: &#123;</span><br><span class="line">                rules: [</span><br><span class="line">                    configurePostcssLoader(MODERN_CONFIG),</span><br><span class="line">                    configureImageLoader(MODERN_CONFIG),</span><br><span class="line">                ],</span><br><span class="line">            &#125;,</span><br><span class="line">            plugins: [</span><br><span class="line">                new webpack.optimize.ModuleConcatenationPlugin(),</span><br><span class="line">                new webpack.BannerPlugin(</span><br><span class="line">                    configureBanner()</span><br><span class="line">                ),</span><br><span class="line">                new ImageminWebpWebpackPlugin(),</span><br><span class="line">                new WorkboxPlugin.GenerateSW(</span><br><span class="line">                    configureWorkbox()</span><br><span class="line">                ),</span><br><span class="line">                new BundleAnalyzerPlugin(</span><br><span class="line">                    configureBundleAnalyzer(MODERN_CONFIG),</span><br><span class="line">                ),</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>通过在我们的<code>module.exports</code>中返回一个数组，我们告诉webpack有多个需要完成的编译：一个用于旧版兼容构建，另一个用于新版构建。</p>
<p>注意，对于旧版兼容构建，我们将处理后的JavaScript输出为<code>[name]-legacy.[hash].js</code>，而新版构建将其输出为<code>[name].[hash].js</code>。</p>
<p>通过将<code>mode</code>设置为<code>production</code>，我们告知webpack这是一个<a href="https://webpack.js.org/concepts/mode/" target="_blank" rel="noopener">生产环境构建</a>，这将启用许多适用于生产环境的设置。</p>
<p>通过将<code>devtool</code>设置为<code>source-map</code>，我们要求将CSS/JavaScript<a href="https://webpack.js.org/configuration/devtool/" target="_blank" rel="noopener">生成单独的<code>.map</code>文件</a>，这是我们更容易调试实时生产环境网站，而无需添加资源的文件大小。</p>
<p>这里使用了几个我们尚未涉及的webpack插件：</p>
<ul>
<li><p><a href="https://www.npmjs.com/package/create-symlink-webpack-plugin" target="_blank" rel="noopener">CreateSymlinkPlugin</a> —— 这是我创建的一个插件，允许在构建过程中创建符号链接，使用它来将生成的<code>favicon.ico</code>符号链接到<code>/favicon.ico</code>，因为许多web浏览器在web根目录中查找。</p>
</li>
<li><p><a href="http://www.npmjs.com/package/save-remote-file-webpack-plugin" target="_blank" rel="noopener">SaveRemoteFilePlugin</a> —— 用于下载远程文件并将其作为webpack构建过程的一部分输出。我用它来下载和提供谷歌的分析。</p>
</li>
<li><p><a href="http://www.npmjs.com/package/imagemin-webp-webpack-plugin" target="_blank" rel="noopener">ImageminWebpWebpackPlugin</a> —— 此插件会为项目导入的所有JPEG和PNG文件创建<code>.webp</code>变体。</p>
</li>
</ul>
<p>直到现在，我们为项目提供了一个很好的生产环境构建。</p>
<h2 id="TAILWIND-CSS-amp-POSTCSS-CONFIG"><a href="#TAILWIND-CSS-amp-POSTCSS-CONFIG" class="headerlink" title="TAILWIND CSS &amp; POSTCSS CONFIG"></a>TAILWIND CSS &amp; POSTCSS CONFIG</h2><p>为了使webpack正确构建Tailwind CSS和其他css，我们需要做一些设置，感谢我的伙伴Jonathan Melville在构建这方面的工作，首先我们需要一个<code>postcss.config.js</code>文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        require(&apos;postcss-import&apos;),</span><br><span class="line">        require(&apos;postcss-extend&apos;),</span><br><span class="line">        require(&apos;postcss-simple-vars&apos;),</span><br><span class="line">        require(&apos;postcss-nested-ancestors&apos;),</span><br><span class="line">        require(&apos;postcss-nested&apos;),</span><br><span class="line">        require(&apos;postcss-hexrgba&apos;),</span><br><span class="line">        require(&apos;autoprefixer&apos;),</span><br><span class="line">        require(&apos;tailwindcss&apos;)(&apos;./tailwind.config.js&apos;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这可以存储在项目根目录中，PostCSS将在构建过程中自动查找它，并应用我们指定的PostCSS插件。请注意，这是我们引入<code>tailwind.config.js</code>文件的位置，以便其成为构建过程的一部分。</p>
<p>最后，我们的CSS入口点<code>app.pcss</code>看起来像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * app.css</span><br><span class="line"> *</span><br><span class="line"> * The entry point for the css.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * This injects Tailwind&apos;s base styles, which is a combination of</span><br><span class="line"> * Normalize.css and some additional base styles.</span><br><span class="line"> *</span><br><span class="line"> * You can see the styles here:</span><br><span class="line"> * https://github.com/tailwindcss/tailwindcss/blob/master/css/preflight.css</span><br><span class="line"> */</span><br><span class="line"> @import &quot;tailwindcss/preflight&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * This injects any component classes registered by plugins.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@import &apos;tailwindcss/components&apos;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Here we add custom component classes; stuff we want loaded</span><br><span class="line"> * *before* the utilities so that the utilities can still</span><br><span class="line"> * override them.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@import &apos;./components/global.pcss&apos;;</span><br><span class="line">@import &apos;./components/typography.pcss&apos;;</span><br><span class="line">@import &apos;./components/webfonts.pcss&apos;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * This injects all of Tailwind&apos;s utility classes, generated based on your</span><br><span class="line"> * config file.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@import &apos;tailwindcss/utilities&apos;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Include styles for individual pages</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@import &apos;./pages/homepage.pcss&apos;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Include vendor css.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"> @import &apos;vendor.pcss&apos;;</span><br></pre></td></tr></table></figure>
<p>显然，对其进行定制以包括用于自定义css的任何组件/界面。</p>
<h2 id="POST-BUILD-PROJECT-TREE"><a href="#POST-BUILD-PROJECT-TREE" class="headerlink" title="POST-BUILD PROJECT TREE"></a>POST-BUILD PROJECT TREE</h2><p>这是我们项目在构建后的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">├── example.env</span><br><span class="line">├── package.json</span><br><span class="line">├── postcss.config.js</span><br><span class="line">├── src</span><br><span class="line">│   ├── css</span><br><span class="line">│   │   ├── app.pcss</span><br><span class="line">│   │   ├── components</span><br><span class="line">│   │   │   ├── global.pcss</span><br><span class="line">│   │   │   ├── typography.pcss</span><br><span class="line">│   │   │   └── webfonts.pcss</span><br><span class="line">│   │   ├── pages</span><br><span class="line">│   │   │   └── homepage.pcss</span><br><span class="line">│   │   └── vendor.pcss</span><br><span class="line">│   ├── fonts</span><br><span class="line">│   ├── img</span><br><span class="line">│   │   └── favicon-src.png</span><br><span class="line">│   ├── js</span><br><span class="line">│   │   ├── app.js</span><br><span class="line">│   │   └── workbox-catch-handler.js</span><br><span class="line">│   └── vue</span><br><span class="line">│       └── Confetti.vue</span><br><span class="line">├── tailwind.config.js</span><br><span class="line">├── templates</span><br><span class="line">├── web</span><br><span class="line">│   ├── dist</span><br><span class="line">│   │   ├── criticalcss</span><br><span class="line">│   │   │   └── index_critical.min.css</span><br><span class="line">│   │   ├── css</span><br><span class="line">│   │   │   ├── styles.d833997e3e3f91af64e7.css</span><br><span class="line">│   │   │   └── styles.d833997e3e3f91af64e7.css.map</span><br><span class="line">│   │   ├── img</span><br><span class="line">│   │   │   └── favicons</span><br><span class="line">│   │   │       ├── android-chrome-144x144.png</span><br><span class="line">│   │   │       ├── android-chrome-192x192.png</span><br><span class="line">│   │   │       ├── android-chrome-256x256.png</span><br><span class="line">│   │   │       ├── android-chrome-36x36.png</span><br><span class="line">│   │   │       ├── android-chrome-384x384.png</span><br><span class="line">│   │   │       ├── android-chrome-48x48.png</span><br><span class="line">│   │   │       ├── android-chrome-512x512.png</span><br><span class="line">│   │   │       ├── android-chrome-72x72.png</span><br><span class="line">│   │   │       ├── android-chrome-96x96.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-114x114.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-120x120.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-144x144.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-152x152.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-167x167.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-180x180.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-57x57.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-60x60.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-72x72.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-76x76.png</span><br><span class="line">│   │   │       ├── apple-touch-icon.png</span><br><span class="line">│   │   │       ├── apple-touch-icon-precomposed.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-1182x2208.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-1242x2148.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-1496x2048.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-1536x2008.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-320x460.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-640x1096.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-640x920.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-748x1024.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-750x1294.png</span><br><span class="line">│   │   │       ├── apple-touch-startup-image-768x1004.png</span><br><span class="line">│   │   │       ├── browserconfig.xml</span><br><span class="line">│   │   │       ├── coast-228x228.png</span><br><span class="line">│   │   │       ├── favicon-16x16.png</span><br><span class="line">│   │   │       ├── favicon-32x32.png</span><br><span class="line">│   │   │       ├── favicon.ico</span><br><span class="line">│   │   │       ├── firefox_app_128x128.png</span><br><span class="line">│   │   │       ├── firefox_app_512x512.png</span><br><span class="line">│   │   │       ├── firefox_app_60x60.png</span><br><span class="line">│   │   │       ├── manifest.json</span><br><span class="line">│   │   │       ├── manifest.webapp</span><br><span class="line">│   │   │       ├── mstile-144x144.png</span><br><span class="line">│   │   │       ├── mstile-150x150.png</span><br><span class="line">│   │   │       ├── mstile-310x150.png</span><br><span class="line">│   │   │       ├── mstile-310x310.png</span><br><span class="line">│   │   │       ├── mstile-70x70.png</span><br><span class="line">│   │   │       ├── yandex-browser-50x50.png</span><br><span class="line">│   │   │       └── yandex-browser-manifest.json</span><br><span class="line">│   │   ├── js</span><br><span class="line">│   │   │   ├── analytics.45eff9ff7d6c7c1e3c3d4184fdbbed90.js</span><br><span class="line">│   │   │   ├── app.30334b5124fa6e221464.js</span><br><span class="line">│   │   │   ├── app.30334b5124fa6e221464.js.map</span><br><span class="line">│   │   │   ├── app-legacy.560ef247e6649c0c24d0.js</span><br><span class="line">│   │   │   ├── app-legacy.560ef247e6649c0c24d0.js.map</span><br><span class="line">│   │   │   ├── confetti.1152197f8c58a1b40b34.js</span><br><span class="line">│   │   │   ├── confetti.1152197f8c58a1b40b34.js.map</span><br><span class="line">│   │   │   ├── confetti-legacy.8e9093b414ea8aed46e5.js</span><br><span class="line">│   │   │   ├── confetti-legacy.8e9093b414ea8aed46e5.js.map</span><br><span class="line">│   │   │   ├── precache-manifest.f774c437974257fc8026ca1bc693655c.js</span><br><span class="line">│   │   │   ├── styles-legacy.d833997e3e3f91af64e7.js</span><br><span class="line">│   │   │   ├── styles-legacy.d833997e3e3f91af64e7.js.map</span><br><span class="line">│   │   │   ├── vendors~confetti~vue.03b9213ce186db5518ea.js</span><br><span class="line">│   │   │   ├── vendors~confetti~vue.03b9213ce186db5518ea.js.map</span><br><span class="line">│   │   │   ├── vendors~confetti~vue-legacy.e31223849ab7fea17bb8.js</span><br><span class="line">│   │   │   ├── vendors~confetti~vue-legacy.e31223849ab7fea17bb8.js.map</span><br><span class="line">│   │   │   └── workbox-catch-handler.js</span><br><span class="line">│   │   ├── manifest.json</span><br><span class="line">│   │   ├── manifest-legacy.json</span><br><span class="line">│   │   ├── report-legacy.html</span><br><span class="line">│   │   ├── report-modern.html</span><br><span class="line">│   │   ├── webapp.html</span><br><span class="line">│   │   └── workbox-catch-handler.js</span><br><span class="line">│   ├── favicon.ico -&gt; dist/img/favicons/favicon.ico</span><br><span class="line">│   ├── index.php</span><br><span class="line">│   ├── offline.html</span><br><span class="line">│   ├── offline.svg</span><br><span class="line">│   └── sw.js</span><br><span class="line">├── webpack.common.js</span><br><span class="line">├── webpack.dev.js</span><br><span class="line">├── webpack.prod.js</span><br><span class="line">├── webpack.settings.js</span><br><span class="line">└── yarn.lock</span><br></pre></td></tr></table></figure>
<h2 id="INJECTING-SCRIPT-amp-CSS-TAGS-IN-YOUR-HTML"><a href="#INJECTING-SCRIPT-amp-CSS-TAGS-IN-YOUR-HTML" class="headerlink" title="INJECTING SCRIPT &amp; CSS TAGS IN YOUR HTML"></a>INJECTING SCRIPT &amp; CSS TAGS IN YOUR HTML</h2><p>通过这里显示的webpack配置，<code>&lt;script&gt;</code>和<code>&lt;style&gt;</code>不会作为生产构建的一部分注入到HTML中，该设置使用<a href="http://craftcms.com/" target="_blank" rel="noopener">Craft CMS</a>，它具有模板系统，我们使用<a href="https://github.com/nystudio107/craft-twigpack" target="_blank" rel="noopener">Twigpack</a>插件注入标签。</p>
<p>如果你没有使用Craft CMS或具有模板引擎的系统，并且希望将这些标记注入到HTML中，那么需要使用<a href="http://github.com/jantimon/html-webpack-plugin" target="_blank" rel="noopener">HtmlWebpackPlugin</a>执行此操作，这个配置已经包含在内，你只需要添加一个配置来告诉它将标签注入到HTML。</p>
<h2 id="CRAFT-CMS-3-INTEGRATION-WITH-THE-TWIGPACK-PLUGIN"><a href="#CRAFT-CMS-3-INTEGRATION-WITH-THE-TWIGPACK-PLUGIN" class="headerlink" title="CRAFT CMS 3 INTEGRATION WITH THE TWIGPACK PLUGIN"></a>CRAFT CMS 3 INTEGRATION WITH THE TWIGPACK PLUGIN</h2><p>如果你没有使用<a href="http://craftcms.com/" target="_blank" rel="noopener">Craft CMS 3</a>，可以跳过这一部分，它只是提供了一些有用的集成信息。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/8/1678d54c7280b364?w=1200&amp;h=675&amp;f=png&amp;s=117830" alt=""></p>
<p>我写了一个叫<a href="http://github.com/nystudio107/craft-twigpack" target="_blank" rel="noopener">Twigpack</a>的免费插件，可以很容易地将我们的webpack构建设置与Craft CMS 3集成。</p>
<p>它处理<code>manifest.json</code>文件以将入口点注入到Twig模板中，甚至用于处理执行旧版/新版模块注入，异步css加载以及更多的模式。</p>
<p>它将使这里介绍的webpack4配置非常简单。</p>
<p>为了包含CSS，我这样做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# if expr=&quot;$HTTP_COOKIE=/critical\-css\=1/&quot; --&gt;</span><br><span class="line">    &#123;&#123; craft.twigpack.includeCssModule(&quot;styles.css&quot;, false) &#125;&#125;</span><br><span class="line">&lt;!--# else --&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        Cookie.set(&quot;critical-css&quot;, &apos;1&apos;, &#123; expires: &quot;7D&quot;, secure: true &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &#123;&#123; craft.twigpack.includeCriticalCssTags() &#125;&#125;</span><br><span class="line"></span><br><span class="line">    &#123;&#123; craft.twigpack.includeCssModule(&quot;styles.css&quot;, true) &#125;&#125;</span><br><span class="line">    &#123;&#123; craft.twigpack.includeCssRelPreloadPolyfill() &#125;&#125;</span><br><span class="line">&lt;!--# endif --&gt;</span><br></pre></td></tr></table></figure>
<p><code>&lt;!--#--&gt;</code>HTML注释是<a href="http://nginx.org/en/docs/http/ngx_http_ssi_module.html" target="_blank" rel="noopener">Nginx Servier Side Includes</a>指令，模式是如果设置了<code>critical-css</code> cookie，用户已经在过去7天访问过我们的网站，那么他们的浏览器应该有网站css缓存，我们只是正常提供网站css。</p>
<p>如果没有设置<code>critical-css</code> cookie，我们通过<a href="">TinyCookie</a>设置cookie，包括我们的Critical CSS，并异步加载站点CSS。有关Critical CSS的详细信息，可以参考<a href="https://nystudio107.com/blog/implementing-critical-css" target="_blank" rel="noopener">Implementing Critical CSS on your website</a>文章。</p>
<p>为了提供我们的javascript，我们只需执行以下操作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; craft.twigpack.includeSafariNomoduleFix() &#125;&#125;</span><br><span class="line">&#123;&#123; craft.twigpack.includeJsModule(&quot;app.js&quot;, true) &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>第二个参数<code>true</code>告诉它将JavaScript异步模块加载，因此生成的HTML如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">!function()&#123;var e=document,t=e.createElement(&quot;script&quot;);if(!(&quot;noModule&quot;in t)&amp;&amp;&quot;onbeforeload&quot;in t)&#123;var n=!1;e.addEventListener(&quot;beforeload&quot;,function(e)&#123;if(e.target===t)n=!0;else if(!e.target.hasAttribute(&quot;nomodule&quot;)||!n)return;e.preventDefault()&#125;,!0),t.type=&quot;module&quot;,t.src=&quot;.&quot;,e.head.appendChild(t),t.remove()&#125;&#125;();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;module&quot; src=&quot;http://example.test/dist/js/app.273e88e73566fecf20de.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script nomodule src=&quot;http://example.test/dist/js/app-legacy.95d36ead9190c0571578.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>有关详细介绍，请查看<a href="http://github.com/nystudio107/craft-twigpack" target="_blank" rel="noopener">Twigpack</a>文档。</p>
<p>这是我使用的完整<code>config/twigpack.php</code>文件，请注意，它具有我在Homestead VM内部运行的本地设置，与你的设置可能不同：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">return [</span><br><span class="line">    // Global settings</span><br><span class="line">    &apos;*&apos; =&gt; [</span><br><span class="line">        // If `devMode` is on, use webpack-dev-server to all for HMR (hot module reloading)</span><br><span class="line">        &apos;useDevServer&apos; =&gt; false,</span><br><span class="line">        // The JavaScript entry from the manifest.json to inject on Twig error pages</span><br><span class="line">        &apos;errorEntry&apos; =&gt; &apos;&apos;,</span><br><span class="line">        // Manifest file names</span><br><span class="line">        &apos;manifest&apos; =&gt; [</span><br><span class="line">            &apos;legacy&apos; =&gt; &apos;manifest-legacy.json&apos;,</span><br><span class="line">            &apos;modern&apos; =&gt; &apos;manifest.json&apos;,</span><br><span class="line">        ],</span><br><span class="line">        // Public server config</span><br><span class="line">        &apos;server&apos; =&gt; [</span><br><span class="line">            &apos;manifestPath&apos; =&gt; &apos;/dist/&apos;,</span><br><span class="line">            &apos;publicPath&apos; =&gt; &apos;/&apos;,</span><br><span class="line">        ],</span><br><span class="line">        // webpack-dev-server config</span><br><span class="line">        &apos;devServer&apos; =&gt; [</span><br><span class="line">            &apos;manifestPath&apos; =&gt; &apos;http://localhost:8080/&apos;,</span><br><span class="line">            &apos;publicPath&apos; =&gt; &apos;http://localhost:8080/&apos;,</span><br><span class="line">        ],</span><br><span class="line">        // Local files config</span><br><span class="line">        &apos;localFiles&apos; =&gt; [</span><br><span class="line">            &apos;basePath&apos; =&gt; &apos;@webroot/&apos;,</span><br><span class="line">            &apos;criticalPrefix&apos; =&gt; &apos;dist/criticalcss/&apos;,</span><br><span class="line">            &apos;criticalSuffix&apos; =&gt; &apos;_critical.min.css&apos;,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    // Live (production) environment</span><br><span class="line">    &apos;live&apos; =&gt; [</span><br><span class="line">    ],</span><br><span class="line">    // Staging (pre-production) environment</span><br><span class="line">    &apos;staging&apos; =&gt; [</span><br><span class="line">    ],</span><br><span class="line">    // Local (development) environment</span><br><span class="line">    &apos;local&apos; =&gt; [</span><br><span class="line">        // If `devMode` is on, use webpack-dev-server to all for HMR (hot module reloading)</span><br><span class="line">        &apos;useDevServer&apos; =&gt; true,</span><br><span class="line">        // The JavaScript entry from the manifest.json to inject on Twig error pages</span><br><span class="line">        &apos;errorEntry&apos; =&gt; &apos;app.js&apos;,</span><br><span class="line">        // webpack-dev-server config</span><br><span class="line">        &apos;devServer&apos; =&gt; [</span><br><span class="line">            &apos;manifestPath&apos; =&gt; &apos;http://localhost:8080/&apos;,</span><br><span class="line">            &apos;publicPath&apos; =&gt; &apos;http://192.168.10.10:8080/&apos;,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h2 id="WRAPPING-UP"><a href="#WRAPPING-UP" class="headerlink" title="WRAPPING UP!"></a>WRAPPING UP!</h2><p>哇，这是一个深坑，当我第一次开始研究webpack时，我很快意识到它是一个非常强大的工具，具有非常强大的功能。你走多远取决于你想要游到多深。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/8/1678d6807ef71a48?w=1200&amp;h=675&amp;f=png&amp;s=709862" alt=""></p>
<p>有关本篇文章的完整源代码，请查看<a href="http://github.com/nystudio107/annotated-webpack-4-config" target="_blank" rel="noopener">annotated-webpack-4-config</a>仓库。</p>
<p>希望这篇文章对你有所帮助，慢慢消化，将它做的更棒。</p>
<h2 id="FURTHER-READING"><a href="#FURTHER-READING" class="headerlink" title="FURTHER READING"></a>FURTHER READING</h2><ul>
<li><p><a href="https://nystudio107.com/blog/a-gulp-workflow-for-frontend-development-automation" target="_blank" rel="noopener">A Gulp Workflow for Frontend Development Automation</a></p>
</li>
<li><p><a href="https://nystudio107.com/blog/image-optimization-project-results" target="_blank" rel="noopener">Post-Mortem: Applied Image Optimization</a></p>
</li>
<li><p><a href="https://nystudio107.com/blog/handling-errors-gracefully-in-craft-cms" target="_blank" rel="noopener">Handling Errors Gracefully in Craft CMS</a></p>
</li>
</ul>
<p>如果你想收到有关新文章的通知，请在推特上关注<a href="https://twitter.com/nystudio107" target="_blank" rel="noopener">@nystudio107</a>。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/前端/" rel="tag"># 前端</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/03/译-Spheres/" rel="next" title="[译] Spheres">
                <i class="fa fa-chevron-left"></i> [译] Spheres
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/11/魅族手机无法打开 inspect 界面解决思路/" rel="prev" title="魅族手机无法打开 inspect 界面解决思路">
                魅族手机无法打开 inspect 界面解决思路 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Lcina</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#采用webpack"><span class="nav-number">1.</span> <span class="nav-text">采用webpack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WHAT-WE-GET-OUT-OF-THE-BOX"><span class="nav-number">2.</span> <span class="nav-text">WHAT WE GET OUT OF THE BOX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PROJECT-TREE-amp-ORGANIZATION"><span class="nav-number">3.</span> <span class="nav-text">PROJECT TREE &amp; ORGANIZATION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANNOTATED-PACKAGE-JSON"><span class="nav-number">4.</span> <span class="nav-text">ANNOTATED PACKAGE.JSON</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANNOTATED-WEBPACK-SETTINGS-JS"><span class="nav-number">5.</span> <span class="nav-text">ANNOTATED WEBPACK.SETTINGS.JS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COMMON-CONVENTIONS-FOR-WEBPACK-CONFIGS"><span class="nav-number">6.</span> <span class="nav-text">COMMON CONVENTIONS FOR WEBPACK CONFIGS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANNOTATED-WEBPACK-COMMON-JS"><span class="nav-number">7.</span> <span class="nav-text">ANNOTATED WEBPACK.COMMON.JS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CONFIGURATION-FUNCTIONS"><span class="nav-number">8.</span> <span class="nav-text">CONFIGURATION FUNCTIONS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BASE-CONFIG"><span class="nav-number">9.</span> <span class="nav-text">BASE CONFIG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LEGACY-CONFIG"><span class="nav-number">10.</span> <span class="nav-text">LEGACY CONFIG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MODERN-CONFIG"><span class="nav-number">11.</span> <span class="nav-text">MODERN CONFIG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MODULE-EXPORTS"><span class="nav-number">12.</span> <span class="nav-text">MODULE.EXPORTS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANNOTATED-WEBPACK-DEV-JS"><span class="nav-number">13.</span> <span class="nav-text">ANNOTATED WEBPACK.DEV.JS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CONFIGURATION-FUNCTIONS-1"><span class="nav-number">14.</span> <span class="nav-text">CONFIGURATION FUNCTIONS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MODULE-EXPORTS-1"><span class="nav-number">15.</span> <span class="nav-text">MODULE.EXPORTS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ANNOTATED-WEBPACK-PROD-JS"><span class="nav-number">16.</span> <span class="nav-text">ANNOTATED WEBPACK.PROD.JS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TAILWIND-EXTRACTOR"><span class="nav-number">17.</span> <span class="nav-text">TAILWIND EXTRACTOR</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CONFIGURATION-FUNCTIONS-2"><span class="nav-number">18.</span> <span class="nav-text">CONFIGURATION FUNCTIONS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MODULE-EXPORTS-2"><span class="nav-number">19.</span> <span class="nav-text">MODULE.EXPORTS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TAILWIND-CSS-amp-POSTCSS-CONFIG"><span class="nav-number">20.</span> <span class="nav-text">TAILWIND CSS &amp; POSTCSS CONFIG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POST-BUILD-PROJECT-TREE"><span class="nav-number">21.</span> <span class="nav-text">POST-BUILD PROJECT TREE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#INJECTING-SCRIPT-amp-CSS-TAGS-IN-YOUR-HTML"><span class="nav-number">22.</span> <span class="nav-text">INJECTING SCRIPT &amp; CSS TAGS IN YOUR HTML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CRAFT-CMS-3-INTEGRATION-WITH-THE-TWIGPACK-PLUGIN"><span class="nav-number">23.</span> <span class="nav-text">CRAFT CMS 3 INTEGRATION WITH THE TWIGPACK PLUGIN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WRAPPING-UP"><span class="nav-number">24.</span> <span class="nav-text">WRAPPING UP!</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FURTHER-READING"><span class="nav-number">25.</span> <span class="nav-text">FURTHER READING</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lcina</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("8Cgz2ufsVnbtprMNRJQXoCT2-gzGzoHsz", "F3rba0mUEIw7dY8SeLRzd9Vq");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
